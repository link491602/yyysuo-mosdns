<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MosDNS 监控面板</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Quicksand:wght@500;600&family=Roboto:wght@400;500;700&family=Product+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-color: #f7f9fd; --text-color: #2c3e50; --card-bg: #ffffff;
            --card-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            --card-shadow-hover: 0 10px 25px rgba(0, 0, 0, 0.12), 0 4px 10px rgba(0, 0, 0, 0.06);
            --border-color: #e0e6ec; --accent-color: #4a90e2;
            --error-color: #e74c3c; --success-color: #2ecc71; --label-color: #7f8c8d;
            --value-color: #34495e; --control-bg: #f0f4f7; --control-border: #d5dce2;
            --control-text: #5e727e; --control-hover-bg: #e5edf3;
            --control-active-bg: var(--accent-color); --control-active-text: #ffffff;
            --status-green: #2ecc71; --status-yellow: #f1c40f;
            --gradient-start: #4a90e2; --gradient-mid: #2e86de; --gradient-end: #4a90e2;
            --radius-main: 0.8rem; --radius-bar: 0.2rem; --radius-control: 0.5rem;
            --danger-bg-color: rgba(231, 76, 60, 0.1); --danger-border-color: rgba(231, 76, 60, 0.3);
            --danger-text-color: #e74c3c; --danger-hover-bg-color: #e74c3c; --danger-hover-text-color: #ffffff;
            --glass-blur-strength: 12px;
            --font-family-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            --focus-ring-color: rgba(74, 144, 226, 0.6);
            /* These are now only default values for general use, not for the fixed log section */
            --timeline-matcher-ok-bg: #e6f4ea; --timeline-matcher-ok-text: #1e4620;
            --timeline-matcher-fail-bg: #fbe9e7; --timeline-matcher-fail-text: var(--error-color); 
            --timeline-plugin-bg: #e3f2fd; --timeline-plugin-text: #0d47a1;
        }
        
        html { 
            font-size: 10.75px; scroll-behavior: smooth; box-sizing: border-box; 
        }
        *, *::before, *::after {
            box-sizing: inherit;
        }
        *:focus-visible {
            outline: 2px solid var(--focus-ring-color);
            outline-offset: 2px;
            border-radius: var(--radius-control);
        }
        input:focus-visible, textarea:focus-visible {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px var(--focus-ring-color);
        }

        body { 
            font-family: var(--font-family-main); margin: 0; padding: 1.2rem; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; 
            transition: background-color 0.4s ease, color 0.4s ease, background-image 0.5s ease-in-out, font-family 0.4s ease; 
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; 
            overflow-x: hidden;
        }
        body.custom-background { background-size: cover; background-position: center; background-attachment: fixed; }
        .header { text-align: center; width: 100%; max-width: 1200px; margin-bottom: 0; }
        .header h1 { font-size: 1.7rem; color: var(--text-color); margin: 0; font-weight: 700; letter-spacing: -0.03em; }
        .header .header-gradient-bar { width: 80px; height: 4px; margin: 0.5rem auto 0.8rem auto; border-radius: var(--radius-bar); background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-mid), var(--gradient-end)); }
        
        .card-title-gradient-bar { width: 100%; height: 3px; border-radius: var(--radius-bar); background-color: var(--accent-color); background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-mid), var(--gradient-end), var(--gradient-start)); background-size: 200% auto; animation: gradient-scroll 6s linear infinite; transition: all 0.4s ease; max-width: 100%; margin: 0.5rem 0 1rem 0; }
        @keyframes gradient-scroll { 100% { background-position: 100% 0%; } }
        
        .main-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1.2rem; width: 100%; max-width: 1800px; flex-grow: 1; margin-bottom: 1.2rem; justify-content: center; }
        .card { background-color: var(--card-bg); border-radius: var(--radius-main); box-shadow: var(--card-shadow); padding: 1.2rem; display: none; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; border: 1px solid var(--border-color); }
        .card.visible { display: flex; }
        .card:hover { transform: translateY(-5px); box-shadow: var(--card-shadow-hover); }
        h2 { font-size: 1.5rem; color: var(--text-color); margin: 0; font-weight: 600; display: flex; align-items: center; gap: 0.7rem; }
        h2 .title-text { flex-grow: 1; text-align: left; display: flex; align-items: center; gap: 0.5rem;}
        h2 .status-dot { width: 0.6rem; height: 0.6rem; border-radius: 50%; transition: background-color 0.3s ease; flex-shrink: 0; }
        h2 .status-dot.status-green { background-color: var(--status-green); } h2 .status-dot.status-yellow { background-color: var(--status-yellow); }
        .charts { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: space-evenly; gap: 1.2rem; align-items: center; width: 100%; padding-top: 0.6rem; margin-top: 0.6rem; border-top: 1px solid var(--border-color); }
        .chart-container { position: relative; width: 110px; height: 110px; }
        #loading-spinner { display: none; width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 4rem auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading #loading-spinner { display: block; }
        .loading #main-content, .loading .control-panel, .loading footer { opacity: 0.5; pointer-events: none; }
        .error-message { color: var(--error-color); font-weight: bold; background-color: rgba(231, 76, 60, 0.1); border: 1px solid var(--error-color); padding: 2rem; border-radius: var(--radius-main); margin: 2rem auto; text-align:center; grid-column: 1 / -1; font-size: 1.2rem; width: fit-content; display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .control-panel { display: grid; grid-template-columns: 2fr 1.2fr; gap: 1.2rem; align-items: stretch; width: 100%; max-width: 1800px; }
        .control-panel:has(#tab-appearance.active), .control-panel:has(#tab-config-mgmt.active) { align-items: start; }
        .left-column, .right-column { display: flex; flex-direction: column; gap: 1.2rem; }
        .control-section { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-main); box-shadow: var(--card-shadow); display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .control-section:hover { box-shadow: var(--card-shadow-hover); }
        .right-column .control-section { flex-grow: 1; padding: 0; }
        .control-section-header { padding: 1.2rem; flex-shrink: 0; }
        .control-section-body { flex-grow: 1; overflow-y: auto; padding: 0 1.2rem 1.2rem 1.2rem; min-height: 0; display: flex; flex-direction: column; }
        .left-column .control-section { padding: 1.2rem; }
        .left-column .control-section-body { overflow-y: visible; padding: 0; }
        .section-title { font-size: 1.1rem; font-weight: 600; color: var(--text-color); margin: 0 0 1rem 0; padding-bottom: 0.7rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 0.7rem; flex-shrink: 0; }
        .section-title .fas, .section-title .fa-solid, .section-title .fa-brands { color: var(--accent-color); font-size: 1.1em; opacity: 0.9; }
        .control-section-body > *:not(.subsection-title) + *:not(.subsection-title) { margin-top: 1rem; }
        
        /* MODIFICATION START: Styles for the combined control bar */
        .refresh-action-bar { 
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            align-items: center; 
            justify-content: flex-start; /* Aligns all content to the left */
            gap: 1.5rem; /* Increased gap between control groups */
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        .control-separator {
            width: 1px;
            height: 24px;
            background-color: var(--control-border);
            margin: 0 0.5rem;
        }

        /* NEW/MODIFIED: Apply consistent button styling to all relevant buttons */
        #dns-log-page-btn,
        #refresh-now-btn,
        #start-capture-btn, 
        #get-logs-btn { 
            background-color: var(--control-bg);
            color: var(--control-text);
            border: 1px solid var(--control-border);
            padding: 0.6rem 1.2rem; /* Consistent padding */
            font-weight: 500;
            font-size: 0.95rem;
            border-radius: var(--radius-control);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Consistent gap between icon and text */
            height: 38px; /* Ensure consistent height */
            box-sizing: border-box; /* Include padding and border in height calculation */
        }
        
        /* NEW/MODIFIED: Hover styles for all consistent buttons */
        #dns-log-page-btn:hover,
        #refresh-now-btn:hover,
        #start-capture-btn:hover, 
        #get-logs-btn:hover { 
            background-color: var(--control-hover-bg);
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }
        
        /* NEW/MODIFIED: Styles for input and span to match button style */
        #capture-duration-input,
        .duration-unit {
            background-color: var(--control-bg);
            border: 1px solid var(--control-border);
            padding: 0.6rem 1.2rem; /* Adjusted padding to match buttons */
            border-radius: var(--radius-control);
            font-size: 0.95rem; /* Consistent font size */
            font-weight: 500; /* Consistent font weight */
            color: var(--control-text);
            text-align: center;
            transition: all 0.2s ease;
            box-sizing: border-box; /* Include padding and border in height calculation */
            height: 38px; /* Match button height approximately */
            display: flex; /* Use flex for vertical centering of text */
            align-items: center;
            justify-content: center;
        }
        #capture-duration-input {
            width: 60px; /* Keep specific width for the number input */
            -moz-appearance: textfield; /* Remove Firefox spinner */
        }
        #capture-duration-input::-webkit-outer-spin-button,
        #capture-duration-input::-webkit-inner-spin-button {
            -webkit-appearance: none; /* Remove Chrome/Safari spinner */
            margin: 0;
        }
        /* Ensure consistency for focus state */
        #capture-duration-input:focus-visible,
        .duration-unit:hover { /* Hover for '秒' unit */
            border-color: var(--accent-color);
            /* Focus-visible box-shadow is handled globally for inputs/textareas */
        }
        
        /* NEW: Ensure icons within these buttons are consistently sized */
        #dns-log-page-btn .fas,
        #refresh-now-btn .fas,
        #start-capture-btn .fas,
        #get-logs-btn .fas {
            font-size: 1em; /* Ensures icon size scales with button text size */
        }
        /* END MODIFICATION */

        .auto-refresh-control { display: flex; align-items: center; gap: 0.8rem; cursor: pointer; }
        .auto-refresh-control .switch-label-text { font-size: 0.95rem; font-weight: 500; color: var(--control-text); }
        .generic-switch-input { display: none; }
        .generic-switch-slider { position: relative; width: 44px; height: 24px; background-color: var(--control-border); border-radius: 12px; transition: background-color 0.3s ease; }
        .generic-switch-slider::before { content: ''; position: absolute; top: 2px; left: 3px; width: 18px; height: 18px; background-color: #fff; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: transform 0.3s ease; }
        .generic-switch-input:checked + .generic-switch-slider { background-color: var(--status-green); }
        .generic-switch-input:checked + .generic-switch-slider:before { transform: translateX(19px); }
        .rule-actions-group { display: flex; flex-direction: column; gap: 0.8rem; }
        .button-group-inline { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .button-group-inline button, .rule-actions-group > button { padding: 0.8rem; font-size: 0.95rem; font-weight: 500; border-radius: var(--radius-control); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s ease; }
        .button-group-inline button { background-color: var(--control-bg); color: var(--control-text); border: 1px solid var(--control-border); }
        .button-group-inline button:hover { background-color: var(--control-hover-bg); border-color: var(--accent-color); transform: translateY(-2px); }
        button.danger { background-color: var(--danger-bg-color); border: 1px solid var(--danger-border-color); color: var(--danger-text-color); }
        button.danger:hover { background-color: var(--danger-hover-bg-color); color: var(--danger-hover-text-color); border-color: var(--danger-hover-bg-color); transform: translateY(-2px); }
        .data-view-group { display: flex; flex-wrap: wrap; gap: 0.6rem; }
        .data-view-group button { background-color: var(--control-bg); color: var(--control-text); border: none; padding: 0.4rem 1rem; font-size: 0.9rem; border-radius: 20px; cursor: pointer; }
        .data-view-group button:hover { background-color: var(--control-hover-bg); color: var(--accent-color); }
        .info-panel-tabs { display: flex; border-bottom: 1px solid var(--border-color); }
        .tab-button { background: none; border: none; padding: 0.8rem 1rem; cursor: pointer; color: var(--label-color); font-weight: 500; font-size: 1rem; position: relative; transition: color 0.2s ease; flex-shrink: 0; white-space: nowrap; }
        .tab-button.active { color: var(--accent-color); }
        .tab-button::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 3px; background-color: var(--accent-color); opacity: 0; transform: scaleX(0.5); transition: all 0.3s ease; }
        .tab-button.active::after { opacity: 1; transform: scaleX(1); }
        .tab-content { display: none; flex-direction: column; gap: 1rem; height: 100%; flex-grow: 1; }
        .tab-content.active { display: flex; }
        .subsection-title { font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--label-color); margin: 1.2rem 0 0.6rem 0; display: flex; align-items: center; gap: 0.5rem;}
        #config-mgmt-container .subsection-title { margin-top: 1.2rem; }
        #config-mgmt-container .subsection-title:first-of-type { margin-top: 0; }
        .subsection-title:first-child { margin-top: 0; }
        .metrics-container { display: grid; grid-template-columns: auto 1fr; gap: 0.7rem 1.2rem; align-items: center; }
        .metric-item { display: contents; } 
        .metric-label { display: flex; align-items: center; gap: 0.7rem; font-weight: 500; color: var(--label-color); font-size: 0.95rem; }
        .metric-label .fas, .metric-label .fa-brands { color: var(--accent-color); width: 1.2em; text-align: center; }
        .metric-value { color: var(--value-color); font-weight: 600; text-align: right; font-size: 0.95rem; word-break: break-all; }
        .metric-value.accent { color: var(--accent-color); font-weight: 700; }
        #last_updated { font-size: 0.9rem; color: var(--label-color); margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border-color); width: 100%; display: flex; align-items: center; gap: 0.5rem; text-align: left; flex-shrink: 0;}
        .theme-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 0.8rem; }
        .card-toggle-group { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .control-base-label { background-color: var(--control-bg); border: 1px solid var(--control-border); padding: 0.6rem 0.9rem; color: var(--control-text); font-size: 0.95rem; font-weight: 500; cursor: pointer; border-radius: var(--radius-control); display: flex; align-items: center; justify-content: flex-start; gap: 0.8rem; }
        .control-base-label:hover { border-color: var(--accent-color); }
        .theme-selector .control-base-label { justify-content: center; font-size: 0.9rem; }
        .control-base-label.active { background-color: var(--control-active-bg); color: var(--control-active-text); border-color: var(--accent-color); box-shadow: 0 3px 8px -2px var(--accent-color); font-weight: 600; }
        .card-toggle-group input[type="checkbox"] { appearance: none; width: 18px; height: 18px; border: 2px solid var(--control-border); border-radius: 4px; background-color: var(--card-bg); position: relative; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; margin: 0; }
        .card-toggle-group input[type="checkbox"]:checked { background-color: var(--accent-color); border-color: var(--accent-color); }
        .card-toggle-group input[type="checkbox"]:checked::after { content: '\2713'; display: block; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; color: white; }
        footer { width: 100%; max-width: 1200px; text-align: center; margin-top: 1.2rem; padding-top: 1.2rem; border-top: 1px solid var(--border-color); font-size: 0.9rem; color: var(--label-color); transition: all 0.4s ease; }
        .footer-content { display: flex; justify-content: center; align-items: center; gap: 1.5rem; flex-wrap: wrap; }
        .footer-item { display: flex; align-items: center; gap: 0.6rem; }
        .footer-icon { color: var(--accent-color); opacity: 0.8; font-size: 1.1em; }
        .footer-separator { width: 1px; height: 16px; background-color: var(--border-color); }
        .blur-control { display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem; }
        .blur-control .switch-label { display: flex; align-items: center; }
        .blur-control input[type="range"] { flex-grow: 1; width: 100%; }
        .mgmt-container { padding: 0; border: none; background: none; border-radius: var(--radius-main); display: flex; flex-direction: column; gap: 1.2rem; flex-grow: 1; }
        .segmented-control { position: relative; display: flex; background-color: var(--control-bg); border-radius: var(--radius-control); padding: 0.3rem; border: 1px solid var(--control-border); }
        .segmented-control .glider { position: absolute; top: 0.3rem; bottom: 0.3rem; width: 50%; background-color: var(--card-bg); border-radius: calc(var(--radius-control) - 0.2rem); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .segmented-control button { flex: 1; padding: 0.7rem; border: none; background-color: transparent; color: var(--control-text); font-weight: 600; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.6rem; z-index: 1; }
        .segmented-control button.active { color: var(--accent-color); }
        .segmented-control.loading { pointer-events: none; opacity: 0.6; }
        .secondary-switches-list { display: flex; flex-direction: column; gap: 0.6rem; }
        .switch-card { display: grid; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-main); padding: 0.8rem 1.2rem; grid-template-columns: auto 1fr auto; align-items: center; gap: 1.2rem; }
        .switch-card .icon-area { font-size: 1.1rem; color: var(--label-color); width: 1.5em; text-align: center; }
        .switch-card .switch-content h4 { margin: 0 0 0.1rem 0; color: var(--value-color); font-size: 1.0rem; display: flex; align-items: center; gap: 0.5rem; }
        .switch-card .switch-content p { margin: 0; color: var(--label-color); font-size: 0.85rem; }
        .switch-card .switch-control { position: relative; }
        .switch-card .apple-switch-input { display: none; }
        .switch-card .apple-switch-slider { position: relative; display: inline-block; width: 40px; height: 22px; background-color: var(--control-border); transition: .4s; border-radius: 22px; cursor: pointer; }
        .switch-card .apple-switch-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .switch-card .apple-switch-input:checked + .apple-switch-slider { background-color: var(--status-green); }
        .switch-card .apple-switch-input:focus + .apple-switch-slider { box-shadow: 0 0 1px var(--status-green); }
        .switch-card .apple-switch-input:checked + .apple-switch-slider:before { transform: translateX(18px); }
        .switch-card.loading .apple-switch-slider { opacity: 0.5; }
        .switch-card .mini-loader { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; border: 2px solid var(--control-border); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .switch-card.loading .mini-loader { display: block; }
        .switch-card.loading .apple-switch-slider:before { display: none; }
        
        .list-mgmt-layout { display: flex; height: 100%; width: 100%; flex-grow: 1; }
        .list-submenu { flex: 0 0 90px; border-right: 1px solid var(--border-color); overflow-y: auto; padding: 1rem 0; display: flex; flex-direction: column; }
        .list-submenu-item { display: flex; align-items: center; gap: 0.6rem; padding: 0.8rem; cursor: pointer; border-left: 3px solid transparent; transition: all 0.2s ease; font-size: 0.95rem; font-weight: 500; color: var(--control-text); }
        .list-submenu-item:hover { background-color: var(--control-hover-bg); }
        .list-submenu-item.active { background-color: color-mix(in srgb, var(--accent-color) 15%, transparent); border-left-color: var(--accent-color); color: var(--accent-color); font-weight: 600; }
        .list-content-area { flex-grow: 1; padding: 0; padding-left: 1.2rem; display: flex; flex-direction: column;}
        .list-mgmt-card { display: none; flex-direction: column; flex-grow: 1; background-color: transparent; border: none; padding: 0; }
        .list-mgmt-card.active { display: flex; }
        .list-mgmt-card textarea { width: 100%; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.9rem; padding: 0.8rem; border-radius: var(--radius-control); border: 1px solid var(--control-border); background-color: var(--control-bg); color: var(--text-color); resize: vertical; flex-grow: 1; overflow-wrap: break-word; }
        .list-mgmt-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; }
        .list-mgmt-card .list-status, .list-mgmt-card .action-area { margin-top: 0; }
        .list-mgmt-card button { background-color: var(--control-hover-bg); color: var(--control-text); border: 1px solid var(--control-border); padding: 0.6rem 1rem; font-weight: 500; font-size: 0.9rem; border-radius: var(--radius-control); cursor: pointer; }
        .list-mgmt-card button:disabled { opacity: 0.7; cursor: not-allowed; }
        .list-mgmt-card button:not(:disabled):hover { background-color: var(--accent-color); color: var(--control-active-text); border-color: var(--accent-color); opacity: 1; transform: translateY(-2px); }
        .list-status .status-text.error { color: var(--error-color); font-weight: bold; }
        .download-btn { font-size: 0.85rem; padding: 0.3rem 0.8rem; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--card-bg); color: var(--text-color); border-radius: var(--radius-main); box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 2rem; width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; align-items: center; gap: 1rem; color: var(--error-color); border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-header i { font-size: 1.5rem; }
        .modal-header h3 { margin: 0; font-size: 1.2rem; }
        .modal-body { font-size: 0.95rem; line-height: 1.7; word-break: break-all; max-height: 60vh; overflow-y: auto; white-space: pre-wrap; }
        .modal-footer { text-align: right; margin-top: 1.5rem; }
        .modal-close-btn { background-color: var(--accent-color); color: var(--control-active-text); border: none; padding: 0.6rem 1.2rem; border-radius: var(--radius-control); cursor: pointer; }

        /* START: MODIFIED/NEW STYLES FOR DATA MODAL */
        .modal-content.data-modal-content {
            max-width: 800px;
            width: 95%;
            padding: 0;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }
        .data-modal-content .modal-header {
            padding: 1rem 1.5rem;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            /* Updated for search box layout */
            display: flex;
            flex-direction: row; /* Main header row */
            justify-content: space-between;
            align-items: flex-start; /* Align search area properly */
            flex-shrink: 0;
        }
        /* New wrapper for title and search area */
        .data-modal-content .modal-header > div:first-child {
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Space between title and search */
            flex-grow: 1; /* Allow title/search to take available space */
        }

        .data-modal-content .modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .modal-close-btn-simple {
            background: none;
            border: none;
            font-size: 2rem;
            line-height: 1;
            color: var(--label-color);
            cursor: pointer;
            padding: 0 0.5rem;
            transition: color 0.2s ease;
        }
        .modal-close-btn-simple:hover {
            color: var(--accent-color);
        }
        .data-modal-content .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
            white-space: normal;
            max-height: initial;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        .data-table th, .data-table td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table thead th {
            background-color: var(--control-bg);
            font-weight: 600;
            color: var(--text-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-table tbody tr:hover {
            background-color: var(--control-hover-bg);
        }
        .data-table td:first-child {
            width: 120px;
            font-weight: 500;
            color: var(--label-color);
        }

        /* Styles for Cache Data Accordion */
        .cache-accordion-container {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        .cache-entry-accordion {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-control);
            overflow: hidden;
            transition: box-shadow 0.2s ease;
        }
        .cache-entry-accordion:hover {
            box-shadow: 0 0 0 1px var(--accent-color);
        }
        .accordion-header {
            background-color: var(--control-bg);
            width: 100%;
            border: none;
            padding: 0.8rem 1.2rem;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            transition: background-color 0.2s ease;
        }
        .accordion-header:hover {
            background-color: var(--control-hover-bg);
        }
        .accordion-header::after {
            content: '\f078'; /* FontAwesome chevron-down */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            transition: transform 0.3s ease;
            color: var(--label-color);
        }
        .accordion-header.active::after {
            transform: rotate(-180deg);
        }
        .accordion-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            background-color: var(--card-bg);
            padding: 0 1.2rem;
        }
        .accordion-panel.active {
             padding: 1.2rem;
        }
        .accordion-panel .metadata-table {
            margin-bottom: 1.2rem;
        }
        .accordion-panel pre {
            background-color: var(--control-bg);
            color: var(--text-color);
            padding: 1rem;
            border-radius: var(--radius-control);
            border: 1px solid var(--border-color);
            font-family: 'SF Mono', 'Fira Code', 'Menlo', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* New styles for data modal search */
        .modal-search-area {
            display: flex;
            flex-direction: column; /* Stack input and info vertically */
            gap: 0.4rem;
            width: 100%;
        }
        .data-modal-search-input {
            width: 100%;
            padding: 0.6rem 1rem;
            border-radius: var(--radius-control);
            border: 1px solid var(--control-border);
            background-color: var(--control-bg);
            color: var(--text-color);
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .data-modal-search-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--focus-ring-color);
            outline: none;
        }
        .data-modal-info-text {
            font-size: 0.85rem;
            color: var(--label-color);
            margin-top: 0.2rem;
            text-align: right;
            padding-right: 0.2rem; /* Give a little padding */
        }
        /* END: MODIFIED/NEW STYLES FOR DATA MODAL */

        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.8rem; }
        .toast { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; border-radius: var(--radius-main); color: #fff; font-weight: 600; font-size: 0.95rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transform: translateX(120%); opacity: 0; animation: toast-in 0.5s cubic-bezier(0.215, 0.61, 0.355, 1) forwards, toast-out 0.5s 3s cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--error-color); }
        .toast i { font-size: 1.2rem; }
        @keyframes toast-in { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(120%); opacity: 0; } }

        .info-tooltip-icon { color: var(--label-color); font-size: 0.9em; cursor: help; transition: color 0.2s ease; display: inline-flex; }
        .info-tooltip-icon:hover { color: var(--accent-color); }
        #global-tooltip { position: fixed; background-color: var(--value-color); color: var(--card-bg); padding: 0.5rem 0.8rem; border-radius: var(--radius-control); font-size: 0.9rem; font-weight: 500; white-space: nowrap; z-index: 10001; opacity: 0; visibility: hidden; transition: opacity 0.2s ease; pointer-events: none; max-width: 300px; white-space: normal; line-height: 1.5; }
        #global-tooltip.active { opacity: 1; visibility: visible; }

        /* MODIFICATION START: Styles for log capture section to fix to light theme */
        .log-capture-section { 
            margin-top: 1.5rem;
            width: 100%;
            max-width: 1800px;
            /* Define local CSS variables for light theme colors */
            --log-text-color: #2c3e50; 
            --log-card-bg: #ffffff;
            --log-border-color: #e0e6ec;
            --log-accent-color: #4a90e2;
            --log-label-color: #7f8c8d;
            --log-value-color: #34495e; 
            --log-control-bg: #f0f4f7;
            --log-error-color: #e74c3c; 
            --log-success-color: #2ecc71; 

            --log-timeline-matcher-ok-bg: #e6f4ea;
            --log-timeline-matcher-ok-text: #1e4620;
            --log-timeline-matcher-fail-bg: #fbe9e7;
            --log-timeline-matcher-fail-text: #e74c3c; /* Fixed to light theme error color */
            --log-timeline-plugin-bg: #e3f2fd;
            --log-timeline-plugin-text: #0d47a1;
        }

        #log-analysis-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1.2rem;
            height: 70vh;
            max-height: 800px;
            /* Apply fixed light theme colors to the main container */
            background-color: var(--log-card-bg); 
            border: 1px solid var(--log-border-color);
            border-radius: var(--radius-main);
        }
        #log-request-list {
            border: none; /* Remove individual border as parent has it */
            overflow-y: auto;
            background-color: transparent; /* Use transparent to show parent's background */
            padding: 0.5rem;
        }
        .log-request-item {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--log-border-color); /* Use fixed border color */
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: var(--log-text-color); /* Default text color */
        }
        .log-request-item:last-child {
            border-bottom: none;
        }
        .log-request-item:hover {
            background-color: var(--log-control-bg); /* Use fixed hover background */
        }
        .log-request-item.active {
            background-color: color-mix(in srgb, var(--log-accent-color) 15%, transparent); /* Use fixed accent color */
            font-weight: 600;
            color: var(--log-accent-color); /* Use fixed accent color */
        }
        .log-request-item .domain {
            font-weight: 600;
            color: var(--log-text-color); /* Use fixed text color */
            display: block;
            margin-bottom: 0.2rem;
        }
        .log-request-item .details {
            font-size: 0.85rem;
            color: var(--log-label-color); /* Use fixed label color */
            display: flex;
            justify-content: space-between;
        }
        #log-flowchart-container {
            border: none; /* Remove individual border as parent has it */
            overflow: auto;
            background-color: transparent; /* Use transparent to show parent's background */
            padding: 1.5rem;
        }
        #log-flowchart-container p { /* For the initial "select a request" message */
            color: var(--log-label-color); /* Use fixed label color */
        }
        
        /* Styles for Log Visualization elements */
        .timeline-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid var(--log-border-color); /* Use fixed border color */
            color: var(--log-text-color); /* Use fixed text color */
        }
        .structured-log-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .log-section-header {
            font-weight: bold;
            color: var(--log-accent-color); /* Use fixed accent color */
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: var(--log-control-bg); /* Use fixed control background */
            border-radius: var(--radius-control);
            border-left: 3px solid var(--log-accent-color); /* Use fixed accent color */
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.8rem;
            border-radius: var(--radius-control);
            transition: background-color 0.2s;
            border: 1px solid transparent;
            border-left-width: 3px;
            color: var(--log-text-color); /* Ensure item text color is fixed */
        }
        .log-item.result-ok {
            background-color: var(--log-timeline-matcher-ok-bg); /* Use fixed color */
            border-color: var(--log-timeline-matcher-ok-text); /* Use fixed color */
        }
        .log-item.result-fail {
            background-color: var(--log-timeline-matcher-fail-bg); /* Use fixed color */
            border-color: var(--log-timeline-matcher-fail-text); /* Use fixed color */
        }
        .log-item.type-plugin {
            background-color: var(--log-timeline-plugin-bg); /* Use fixed color */
            border-color: var(--log-timeline-plugin-text); /* Use fixed color */
        }
        .log-item-main {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        .log-item .icon {
            font-size: 1.1em;
            width: 20px;
            text-align: center;
        }
        .log-item.type-matcher .icon { color: var(--log-label-color); } /* Use fixed label color */
        .log-item.result-ok .icon { color: var(--log-timeline-matcher-ok-text); } /* Use fixed color */
        .log-item.result-fail .icon { color: var(--log-timeline-matcher-fail-text); } /* Use fixed color */
        .log-item.type-plugin .icon { color: var(--log-timeline-plugin-text); } /* Use fixed color */
        .log-item .name {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            color: var(--log-text-color); /* Explicitly set text color */
        }
        .log-item-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
            flex-shrink: 0;
            margin-left: 1rem;
            color: var(--log-text-color); /* Fixed text color for meta data */
        }
        .log-item-meta .result {
            font-weight: bold;
        }
        .log-item-meta .result.ok { color: var(--log-timeline-matcher-ok-text); } /* Use fixed color */
        .log-item-meta .result.fail { color: var(--log-timeline-matcher-fail-text); } /* Use fixed color */
        .log-item-meta .time {
            color: var(--log-label-color); /* Use fixed label color */
            font-variant-numeric: tabular-nums;
        }

        /* Fixed table styling for raw logs inside log-flowchart-container */
        #log-flowchart-container .data-table {
            color: var(--log-text-color); /* Ensure table text color is fixed */
        }
        #log-flowchart-container .data-table th,
        #log-flowchart-container .data-table td {
            border-bottom: 1px solid var(--log-border-color); /* Use fixed border color */
        }
        #log-flowchart-container .data-table thead th {
            background-color: var(--log-control-bg); /* Use fixed control background */
            color: var(--log-text-color); /* Fixed text color for table headers */
        }
        #log-flowchart-container .data-table tbody tr:hover {
            background-color: var(--log-control-bg); /* Use fixed control background for hover */
        }
        #log-flowchart-container .data-table td:first-child {
            color: var(--log-label-color); /* Fixed color for first column */
        }
        #log-flowchart-container .data-table .result.ok {
            color: var(--log-timeline-matcher-ok-text); /* Fixed color */
        }
        #log-flowchart-container .data-table .result.fail {
            color: var(--log-timeline-matcher-fail-text); /* Fixed color */
        }
        /* MODIFICATION END */

        @media (max-width: 1200px) { .control-panel { grid-template-columns: 1fr; } }
        
        @media (max-width: 768px) { 
            html { font-size: 14.5px; }
            body { padding: 1rem; }
            .header h1 { font-size: 1.8rem; }
            .card { padding: 1.2rem; }
            h2 { font-size: 1.3rem; }
            .chart-container { width: 90px; height: 90px; }
            .control-panel { gap: 1.5rem; }
            .left-column { gap: 1.5rem; }
            .info-panel-tabs { flex-wrap: wrap; overflow-x: auto; border-bottom: none; margin: 0; padding-bottom: 0.5rem; gap: 0.5rem; scrollbar-width: none; }
            .info-panel-tabs::-webkit-scrollbar { display: none; }
            .tab-button { flex: 1 1 auto; min-width: 90px; background-color: var(--control-bg); border: 1px solid var(--control-border); color: var(--control-text); border-radius: var(--radius-control); text-align: center; justify-content: center; padding: 0.6rem 0.5rem; font-size: 0.9rem; }
            .tab-button.active { background-color: var(--accent-color); color: var(--control-active-text); border-color: var(--accent-color); font-weight: 600; }
            .tab-button::after { display: none; }
            
            #metrics-system { grid-template-columns: auto 1fr; gap: 0.8rem 1rem; }
            #metrics-system .metric-label, #metrics-system .metric-value { font-size: 0.95rem; padding: 0.5rem 0; }
            #metrics-system .metric-value { text-align: right; word-break: break-all; }
            #tab-system-info #last_updated { font-size: 0.85rem; }
            
            #appearance-container { display: flex; flex-direction: column; gap: 1.5rem; }
            #appearance-container .subsection-title { margin-bottom: 0.5rem; }
            #appearance-container .theme-selector, #appearance-container .card-toggle-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.8rem; }
            
            .switch-card { grid-template-columns: auto 1fr auto; align-items: center; gap: 0 1.2rem; padding: 1rem 1.2rem; }
            .switch-card .switch-control { grid-column: auto; justify-self: auto; margin-top: 0; }

            .list-mgmt-layout { flex-direction: column; } 
            .list-submenu { flex-direction: row; flex-wrap: wrap; justify-content: flex-start; gap: 0.5rem; border-right: none; border-bottom: 1px solid var(--border-color); margin: 0; padding: 0.8rem 0; } 
            
            .list-submenu-item { flex: 0 1 auto; text-align: center; justify-content: center; border-left: none; border-bottom: none; padding: 0.5rem 1rem; border-radius: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 1px solid var(--control-border); background-color: var(--control-bg); }
            .list-submenu-item:hover { border-color: var(--accent-color); background-color: var(--control-hover-bg); }
            .list-submenu-item.active { background-color: var(--accent-color); color: var(--control-active-text); border-color: var(--accent-color); font-weight: 600; } 
            
            .list-content-area { padding: 0; }
            footer .footer-content { flex-direction: column; gap: 0.8rem; }
            footer .footer-separator { display: none; }

            /* MODIFICATION START: Responsive styles for log capture - ensure it uses fixed colors */
            #log-analysis-container { 
                grid-template-columns: 1fr; 
                height: auto; 
                /* Fixed background/border remain from parent log-capture-section */
            }
            #log-request-list { max-height: 40vh; }
            #log-flowchart-container { min-height: 50vh; }

            /* Remove mobile-specific overrides that would re-apply global theme colors */
            /* e.g., NO .log-request-item { color: var(--text-color); } etc. */
            /* All relevant log-section styles should already use --log- prefix */
            /* The only thing to consider is if global media query styling impacts them unexpectedly, but direct --log- var usage should prevent this */
            /* For instance, if .data-table was affected by a global mobile rule, we'd need to re-assert its --log- var colors */
            /* Re-checked and confirmed that existing rules correctly point to --log- vars within this section. */
            /* So no specific mobile overrides are needed here for colors, as they're already fixed. */
        }
    </style>
</head>
<body>
    <div class="header"><h1>MosDNS 监控面板</h1><div class="header-gradient-bar"></div></div>
    <div id="loading-spinner"></div>
    <div id="main-content" class="main-container"></div>
    <div class="control-panel">
        <div class="left-column">
            <section class="control-section">
                <div class="control-section-body">
                    <h4 class="section-title"><i class="fas fa-cogs"></i> 控制中心</h4>
                    
                    <!-- MODIFICATION START: Combined control bar and style alignment -->
                    <div class="refresh-action-bar">
                        <div class="control-group">
                            <label for="auto-refresh-toggle" class="auto-refresh-control">
                                <span class="switch-label-text">自动刷新</span>
                                <input type="checkbox" id="auto-refresh-toggle" class="generic-switch-input">
                                <span class="generic-switch-slider"></span>
                            </label>
                            <button id="refresh-now-btn" class="btn"><i class="fas fa-sync-alt"></i> 立即刷新</button>
                        </div>

                        <div class="control-separator"></div>

                        <div class="control-group">
                            <button id="start-capture-btn" class="btn">
                                <i class="fas fa-bug"></i> 日志抓取
                            </button>
                            <input type="number" id="capture-duration-input" value="15" min="1" max="600">
                            <span class="duration-unit">秒</span>
                            <i class="fas fa-info-circle info-tooltip-icon" data-tooltip="点击开始抓取。到期后debug会自动关闭，日志在获取一次后自动清空。"></i>
                            <button id="get-logs-btn" class="btn">
                                <i class="fas fa-search"></i> 分析日志
                            </button>
                            <button id="dns-log-page-btn" class="btn">
                                <i class="fas fa-list-alt"></i> DNS请求记录
                            </button>
                        </div>
                    </div>
                    <!-- MODIFICATION END -->

                    <div class="rule-actions-group" style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                        <div class="button-group-inline"><button id="save-rules-btn" class="btn"><i class="fas fa-save"></i> 保存分流规则</button><button id="flush-cache-btn" class="btn"><i class="fas fa-broom"></i> 清空全部缓存</button></div>
                        <div class="button-group-inline" style="margin-top:0.8rem"><button id="flush-rules-btn" class="btn danger"><i class="fas fa-trash-alt"></i> 清空分流规则</button><button id="restart-mosdns-btn" class="btn danger"><i class="fas fa-redo"></i> 重启 MosDNS</button></div>
                    </div>
                </div>
            </section>
            <section class="control-section">
                 <div class="control-section-body">
                    <h4 class="section-title"><i class="fas fa-eye"></i> 数据查看</h4>
                    <div class="data-view-group" id="data-view-buttons"></div>
                </div>
            </section>
        </div>
        <div class="right-column">
             <section class="control-section">
                <div class="control-section-header">
                    <div class="info-panel-tabs">
                        <button class="tab-button active" data-tab="system-info"><i class="fas fa-server"></i> 系统信息</button>
                        <button class="tab-button" data-tab="appearance"><i class="fas fa-palette"></i> 外观设置</button>
                        <button class="tab-button" data-tab="config-mgmt"><i class="fas fa-toggle-on"></i> 功能开关</button>
                        <button class="tab-button" data-tab="list-mgmt"><i class="fas fa-list-alt"></i> 名单管理</button>
                    </div>
                </div>
                <div class="control-section-body">
                    <div id="tab-system-info" class="tab-content active">
                        <div class="metrics-container" id="metrics-system"></div>
                        <p id="last_updated"><i class="fas fa-clock"></i> </p>
                    </div>
                    <div id="tab-appearance" class="tab-content">
                        <div id="appearance-container">
                            <h5 class="subsection-title">主题切换</h5>
                            <div class="theme-selector" id="theme-selector"></div>
                            <h5 class="subsection-title">自定义背景</h5>
                            <div class="button-group-inline">
                                <button id="set-bg-btn" class="btn"><i class="fas fa-image"></i> 设置背景 URL</button>
                                <button id="remove-bg-btn" class="btn danger"><i class="fas fa-trash"></i> 移除背景</button>
                            </div>
                            <h5 class="subsection-title">毛玻璃强度</h5>
                            <div class="blur-control">
                                <label for="blur-toggle" class="switch-label">
                                    <input type="checkbox" id="blur-toggle" class="generic-switch-input">
                                    <span class="generic-switch-slider"></span>
                                </label>
                                <input type="range" id="blur-slider" min="0" max="30" value="12" step="1">
                            </div>
                            <h5 class="subsection-title">显示缓存卡片</h5>
                            <div class="card-toggle-group" id="card-toggles"></div>
                        </div>
                    </div>
                    <div id="tab-config-mgmt" class="tab-content">
                        <div id="config-mgmt-container" class="mgmt-container"></div>
                    </div>
                    <div id="tab-list-mgmt" class="tab-content">
                        <div id="list-mgmt-container" class="mgmt-container"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- MODIFICATION START: Log capture section now has fixed light theme styling -->
    <div class="log-capture-section">
        <div id="log-analysis-container" style="display: none;">
            <div id="log-request-list"></div>
            <div id="log-flowchart-container">
                <p style="color: var(--log-label-color); margin-top: 2rem;">请从左侧列表选择一个请求以查看流程。</p>
            </div>
        </div>
    </div>
    <!-- MODIFICATION END -->

    <footer>
        <div class="footer-content">
            <div class="footer-item"><i class="fas fa-code-branch footer-icon"></i><span>UI 版本: Core-Max v2.3.1 FINAL</span></div>
            <div class="footer-separator"></div>
            <div class="footer-item"><i class="fas fa-users-cog footer-icon"></i><span>技术支持: P佬 & 熊佬 & Jimmy</span></div>
        </div>
    </footer>

    <div id="error-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>操作失败</h3>
            </div>
            <div class="modal-body">
                <p id="error-modal-message"></p>
            </div>
            <div class="modal-footer">
                <button id="error-modal-close" class="modal-close-btn">关闭</button>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>
    <div id="global-tooltip"></div>
    
    <div id="data-view-modal" class="modal-overlay">
        <div class="modal-content data-modal-content">
            <div class="modal-header">
                <div>
                    <h3 id="data-modal-title">数据查看</h3>
                    <div class="modal-search-area">
                        <input type="text" id="data-modal-search" placeholder="搜索域名..." class="data-modal-search-input">
                        <span id="data-modal-info" class="data-modal-info-text"></span>
                    </div>
                </div>
                <button id="data-modal-close" class="modal-close-btn-simple">×</button>
            </div>
            <div id="data-modal-body" class="modal-body"></div>
        </div>
    </div>
    
    <script>
        // --- MODIFICATION START ---
        // I have reviewed and refactored the entire script block for clarity, 
        // bug fixes, and new features. The logic is preserved but improved.
        // --- MODIFICATION END ---
        
        const REFRESH_INTERVAL = 5000;
        const MAX_LINES_TO_DISPLAY = 500;
        const D = document; 
        const getById = (id) => D.getElementById(id);

        let chartInstances = {}; 
        let autoRefreshTimer = null; 
        let isRefreshing = false; 
        let currentTheme = 'light';
        let coreMode = 'A';
        let isMgmtTabInitialized = { config: false, list: false };

        let currentModalData = { type: null, rawEntries: [], filteredEntries: [], totalCount: 0, loadTime: 0 };
        let dataModalSearchInput = null;
        
        const iconMap = { 
            '请求总数': 'fa-globe', '缓存命中': 'fa-check-circle', '过期缓存命中': 'fa-history', 
            '缓存命中率': 'fa-bullseye', '过期缓存命中率': 'fa-bullseye', '缓存条目数': 'fa-database', 
            '启动时间': 'fa-power-off', 'CPU 时间': 'fa-microchip', '常驻内存 (RSS)': 'fa-memory', 
            '待用堆内存 (Idle)': 'fa-box-open', 'Go 版本': 'fa-code-branch', '线程数': 'fa-sitemap', 
            '打开文件描述符': 'fa-folder-open' 
        };

        const switchProfiles = [
            { tag: 'switch3', name: '核心运行模式', tip: '切换后将清空自动生成的分流规则，确保完全按照新模式分流（兼容/安全模式理论上分流效果无差异）。兼容模式性能更高，安全模式防泄露和劫持能力更强。', modes: { 'A': { name: '兼容模式', icon: 'fa-globe-americas' }, 'B': { name: '安全模式', icon: 'fa-shield-alt' }}},
            { tag: 'switch1', name: '请求屏蔽开关', desc: '对无解析结果的请求进行屏蔽', tip: '建议开启，避免无ipv4及ipv6结果的非必要DNS解析。', icon: 'fa-ban', valueForOn: 'A' },
            { tag: 'switch5', name: '类型屏蔽开关', desc: '屏蔽 SOA、PTR、HTTPS 等请求类型', tip: '建议开启，可减少不必要的网络请求，提高效率。', icon: 'fa-ban', valueForOn: 'A' },
            { tag: 'switch6', name: 'IPV6屏蔽开关', desc: '屏蔽AAAA请求类型', tip: '无IPV6网络环境建议开启', icon: 'fa-ban', valueForOn: 'A' },
            { tag: 'switch2', name: '指定 Client 开关', desc: '对特定客户端 IP 应用分流策略', tip: '按需开启。需要 MosDNS 监听53端口，并正确配置 client_ip 名单。', icon: 'fa-user-secret', valueForOn: 'A' },
            { tag: 'switch4', name: '过期缓存开关', desc: '启用 Lazy Cache（乐观缓存）', tip: '建议开启，可以提升重复查询的响应速度，即使缓存已过期。', icon: 'fa-history', valueForOn: 'A' },
        ];
        
        const ipSetProfiles = [ 
            { tag: 'client_ip', name: '客户端 IP (IPSet)', icon: 'fa-network-wired' } 
        ];
        const domainSetProfiles = [
            { tag: 'whitelist', name: '白名单', icon: 'fa-check-circle' },
            { tag: 'blocklist', name: '黑名单', icon: 'fa-ban' },
            { tag: 'greylist', name: '灰名单', icon: 'fa-plane' },
            { tag: 'ddnslist', name: 'DDNS 域名', icon: 'fa-sync-alt' },
        ];
        const hostsProfiles = [];
        const ruleListPaths = ['top_domains/flush', 'my_fakeiplist/flush', 'my_nodenov4list/flush', 'my_nodenov6list/flush', 'my_notinlist/flush', 'my_nov4list/flush', 'my_nov6list/flush', 'my_realiplist/flush'];

        Chart.register(ChartDataLabels); Chart.defaults.plugins.legend.display = false; Chart.defaults.plugins.datalabels.font = { weight: 'bold', size: 11 }; Chart.defaults.cutout = '70%'; Chart.defaults.responsive = true; Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.plugins.datalabels.formatter = (v, c) => { const s = c.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); return s > 0 && v / s > 0.05 ? `${(v / s * 100).toFixed(0)}%` : ''; };
        
        function createElement(tag, className, innerText = '', id = '') { const el = D.createElement(tag); if (className) el.className = className; if (innerText) el.innerText = innerText; if (id) el.id = id; return el; }
        function formatNumber(num) { if (typeof num !== 'number' && isNaN(num = parseFloat(num))) { return num; } return num.toLocaleString('en-US'); }

        function showToast(message, type = 'success', duration = 3500) {
            const container = getById('toast-container');
            const toast = createElement('div', `toast ${type}`);
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            toast.style.animationDelay = `0s, ${(duration / 1000) - 0.5}s`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }
        
        const themeMap = {
            'light': { name: '默认亮色', icon: 'fas fa-sun', cssVars: { '--bg-color': '#f7f9fd', '--text-color': '#2c3e50', '--card-bg': '#ffffff', '--card-shadow': '0 6px 18px rgba(0, 0, 0, 0.08)', '--border-color': '#e0e6ec', '--accent-color': '#4a90e2', '--label-color': '#7f8c8d', '--value-color': '#34495e', '--control-bg': '#f0f4f7', '--control-border': '#d5dce2', '--control-text': '#5e727e', '--control-hover-bg': '#e5edf3', '--control-active-bg': '#4a90e2', '--control-active-text': '#ffffff', '--status-green': '#2ecc71', '--gradient-start': '#4a90e2', '--gradient-mid': '#2e86de', '--gradient-end': '#4a90e2', '--font-family-main': "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif" }, chartColors: { hit: 'rgba(74, 144, 226, 0.7)', miss: 'rgba(189, 195, 199, 0.3)', text: '#2c3e50' } },
            'dark': { name: '默认暗色', icon: 'fas fa-moon', cssVars: { '--bg-color': '#1a1a1a', '--text-color': '#e0e0e0', '--card-bg': '#282828', '--card-shadow': '0 8px 25px rgba(0, 0, 0, 0.5)', '--border-color': '#3a3a3a', '--accent-color': '#5096ff', '--label-color': '#bbbbbb', '--value-color': '#ffffff', '--control-bg': '#353535', '--control-border': '#4a4a4a', '--control-text': '#e0e0e0', '--control-hover-bg': '#404040', '--control-active-bg': '#5096ff', '--control-active-text': '#ffffff', '--status-green': '#2ecc71', '--gradient-start': '#5096ff', '--gradient-mid': '#3a7ce0', '--gradient-end': '#5096ff', '--font-family-main': "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif" }, chartColors: { hit: 'rgba(80, 150, 255, 0.7)', miss: 'rgba(100, 100, 100, 0.3)', text: '#e0e0e0' }, extraStyles: { 'h1, h2, h4, .section-title, .metric-label, .metric-value, .switch-label-text, .tab-button, footer, .control-base-label, .data-view-group button': 'text-shadow: 0 1px 3px rgba(0,0,0,0.5);', '.fas, .fa-brands': 'filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));' } },
            'glass': { name: '高光琉璃', icon: 'fas fa-gem', cssVars: { '--bg-color': 'transparent', '--text-color': '#ffffff', '--card-bg': 'rgba(255, 255, 255, 0.1)', '--card-shadow': '0 8px 32px 0 rgba(0, 0, 0, 0.37)', '--border-color': 'rgba(255, 255, 255, 0.2)', '--accent-color': '#90b8ff', '--label-color': '#d0d0d0', '--value-color': '#ffffff', '--control-bg': 'rgba(255, 255, 255, 0.15)', '--control-border': 'rgba(255, 255, 255, 0.2)', '--control-text': '#f0f0f0', '--control-hover-bg': 'rgba(255, 255, 255, 0.25)', '--control-active-bg': '#90b8ff', '--control-active-text': '#1a1a1a', '--status-green': '#2ecc71', '--gradient-start': '#82aaff', '--gradient-mid': '#c792ea', '--gradient-end': '#82aaff', '--font-family-main': "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif" }, chartColors: { hit: 'rgba(130, 170, 255, 0.7)', miss: 'rgba(255, 255, 255, 0.15)', text: '#ffffff' }, extraStyles: { '.card, .control-section': 'backdrop-filter: blur(var(--glass-blur-strength)); -webkit-backdrop-filter: blur(var(--glass-blur-strength)); background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0) 60%); box-shadow: inset 0 1.5px 1px 0 rgba(255, 255, 255, 0.1), var(--card-shadow); border: none; transition: all 0.3s ease, backdrop-filter 0.2s ease-out, -webkit-backdrop-filter 0.2s ease-out;', 'h1, h2, h4, .section-title, .metric-label, .metric-value, .switch-label-text, .tab-button, footer, .control-base-label, .data-view-group button': 'text-shadow: 0 1px 4px rgba(0,0,0,0.6);', '.fas, .fa-brands': 'filter: drop-shadow(0 1px 3px rgba(0,0,0,0.5));' } },
            'material': { name: '谷歌设计', icon: 'fa-brands fa-google', cssVars: { '--bg-color': '#f8f9fa', '--text-color': '#202124', '--card-bg': '#ffffff', '--card-shadow': '0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15)', '--border-color': '#dadce0', '--accent-color': '#4285f4', '--label-color': '#5f6368', '--value-color': '#202124', '--control-bg': '#f1f3f4', '--control-border': '#dadce0', '--control-text': '#3c4043', '--control-hover-bg': '#e8eaed', '--control-active-bg': '#4285f4', '--control-active-text': '#ffffff', '--status-green': '#34a853', '--gradient-start': '#4285f4', '--gradient-mid': '#fbbc05', '--gradient-end': '#34a853', '--font-family-main': "'Product Sans', 'Roboto', sans-serif" }, chartColors: { hit: 'rgba(52, 168, 83, 0.8)', miss: 'rgba(234, 67, 53, 0.8)', text: '#202124' }, extraStyles: { 'body': 'background-image: url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'%3E%3Cg fill-rule=\'evenodd\'%3E%3Cg fill=\'%23e8eaed\' fill-opacity=\'0.4\'%3E%3Cpath opacity=\'.5\' d=\'M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z\'/%3E%3Cpath d=\'M6 5V0h1v5h5v1H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");', '.card, .control-section': 'border-radius: 8px;', '.control-base-label, #refresh-now-btn, .data-view-group button': 'border-radius: 20px;', '.card-title-gradient-bar': 'background-image: linear-gradient(to right, #4285f4, #ea4335, #fbbc05, #34a853); animation: none;', '.fas, .fa-brands': 'text-shadow: 1px 1px 2px rgba(0,0,0,0.1);' } }, 
            'cupertino_light': { name: '苹果浅色', icon: 'fas fa-sun', cssVars: { '--bg-color': '#f5f5f7', '--text-color': '#1d1d1f', '--card-bg': '#ffffff', '--card-shadow': '0 4px 15px rgba(0,0,0,0.08)', '--border-color': '#d2d2d7', '--accent-color': '#007aff', '--label-color': '#6e6e73', '--value-color': '#1d1d1f', '--control-bg': '#e9e9eb', '--control-border': '#d2d2d7', '--control-text': '#3a3a3c', '--control-hover-bg': '#e1e1e3', '--control-active-bg': '#007aff', '--control-active-text': '#ffffff', '--status-green': '#34c759', '--gradient-start': '#007aff', '--gradient-mid': '#007aff', '--gradient-end': '#007aff', '--font-family-main': "-apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif" }, chartColors: { hit: 'rgba(0, 122, 255, 0.8)', miss: 'rgba(142, 142, 147, 0.6)', text: '#1d1d1f' }, extraStyles: { '.card, .control-section': 'border-radius: 12px;', 'h1, h2, h4': 'font-weight: 600;', '.metric-value': 'font-weight: 500;', '.card-title-gradient-bar': 'background-image: none;' } },
            'cupertino_dark': { name: '苹果暗色', icon: 'fa-brands fa-apple', cssVars: { '--bg-color': '#1d1d1f', '--text-color': 'rgba(255, 255, 255, 0.9)', '--card-bg': 'rgba(50, 50, 52, 0.7)', '--card-shadow': '0 12px 30px rgba(0,0,0,0.6)', '--border-color': 'rgba(84, 84, 88, 0.65)', '--accent-color': '#0a84ff', '--label-color': 'rgba(235, 235, 245, 0.6)', '--value-color': '#ffffff', '--control-bg': 'rgba(60, 60, 62, 0.8)', '--control-border': 'rgba(84, 84, 88, 0.65)', '--control-text': 'rgba(255, 255, 255, 0.9)', '--control-hover-bg': 'rgba(80, 80, 82, 0.9)', '--control-active-bg': '#0a84ff', '--control-active-text': '#ffffff', '--status-green': '#32d74b', '--gradient-start': '#0a84ff', '--gradient-mid': '#5e5ce6', '--gradient-end': '#bf5af2', '--font-family-main': "-apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif" }, chartColors: { hit: 'rgba(10, 132, 255, 0.8)', miss: 'rgba(94, 92, 230, 0.5)', text: 'rgba(255, 255, 255, 0.9)' }, extraStyles: { '.card, .control-section': 'backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 12px;', 'h1, h2, h4': 'font-weight: 600;', '.metric-value': 'font-weight: 500;' } },
            'cyberpunk': { name: '赛博朋克', icon: 'fas fa-bolt', cssVars: { '--bg-color': '#1a0933', '--text-color': '#e0d8f0', '--card-bg': 'rgba(26, 9, 51, 0.6)', '--card-shadow': '0 0 15px rgba(255, 0, 234, 0.3), 0 0 30px rgba(0, 255, 255, 0.3)', '--border-color': 'rgba(0, 255, 255, 0.5)', '--accent-color': '#ff00ea', '--label-color': '#9085a6', '--value-color': '#f8f8f2', '--control-bg': 'rgba(52, 18, 104, 0.5)', '--control-border': 'rgba(255, 0, 234, 0.6)', '--control-text': '#e0d8f0', '--control-hover-bg': 'rgba(255, 0, 234, 0.25)', '--control-active-bg': '#ff00ea', '--control-active-text': '#f8f8f2', '--status-green': '#00ffff', '--gradient-start': '#ff00ea', '--gradient-mid': '#00ffff', '--gradient-end': '#ff00ea', '--font-family-main': "'Orbitron', 'Turret Road', 'Michroma', sans-serif" }, chartColors: { hit: 'rgba(255, 0, 234, 0.8)', miss: 'rgba(0, 255, 255, 0.6)', text: '#f8f8f2' }, extraStyles: { 'body': 'background: #1a0933 linear-gradient(180deg, rgba(26, 9, 51, 0) 0%, #341268 100%);', 'h1, h2, h4, .section-title, .metric-value, button': 'text-shadow: 0 0 5px var(--accent-color);', '.card, .control-section': 'border-image: linear-gradient(to bottom right, var(--accent-color), #00ffff) 1; border-image-slice: 1; border-style: solid; border-width: 1px;' } },
            'kawaii': { name: '粉彩可爱', icon: 'fas fa-cat', cssVars: { '--bg-color': '#fcefee', '--text-color': '#5e4856', '--card-bg': 'rgba(255, 255, 255, 0.7)', '--card-shadow': '0 6px 20px rgba(234, 182, 182, 0.4)', '--border-color': 'rgba(234, 182, 182, 0.5)', '--accent-color': '#ff8a8a', '--label-color': '#a08a9a', '--value-color': '#5e4856', '--control-bg': '#f9e0e0', '--control-border': '#f5c6c6', '--control-text': '#8c6d7d', '--control-hover-bg': '#f5c6c6', '--control-active-bg': '#ff8a8a', '--control-active-text': '#ffffff', '--status-green': '#ffc0cb', '--gradient-start': '#ff8a8a', '--gradient-mid': '#ffd3b6', '--gradient-end': '#ff8a8a', '--font-family-main': "'Quicksand', sans-serif", '--radius-main': '1.2rem', '--radius-control': '2rem' }, chartColors: { hit: 'rgba(255, 138, 138, 0.8)', miss: 'rgba(204, 184, 212, 0.8)', text: '#5e4856' }, extraStyles: { 'body': 'background-image: url("data:image/svg+xml,%3Csvg width=\'6\' height=\'6\' viewBox=\'0 0 6 6\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23eadada\' fill-opacity=\'0.4\' fill-rule=\'evenodd\'%3E%3Cpath d=\'M5 0h1L0 6V5zM6 5v1H5z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");', 'h1,h2,h4': 'font-weight: 600;' } },
            'miku': { name: '初音未来', icon: 'fas fa-music', cssVars: { '--bg-color': '#1c2833', '--text-color': '#fdfefe', '--card-bg': 'rgba(35, 55, 75, 0.85)', '--card-shadow': '0 8px 25px rgba(0, 0, 0, 0.5)', '--border-color': '#3498db', '--accent-color': '#39c5bb', '--label-color': '#aed6f1', '--value-color': '#ffffff', '--control-bg': 'rgba(46, 64, 83, 0.9)', '--control-border': '#5dade2', '--control-text': '#eaf2f8', '--control-hover-bg': 'rgba(93, 173, 226, 0.5)', '--control-active-bg': '#39c5bb', '--control-active-text': '#17202a', '--status-green': '#39c5bb', '--gradient-start': '#39c5bb', '--gradient-mid': '#ff4571', '--gradient-end': '#39c5bb', '--font-family-main': "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif" }, chartColors: { hit: 'rgba(57, 197, 187, 0.8)', miss: 'rgba(255, 69, 113, 0.5)', text: '#fdfefe' }, extraStyles: {'body': 'background-color: #1c2833; background-image: linear-gradient(160deg, #1c2833 0%, #2e4053 100%);'} },
            'eva': { name: '初号机', icon: 'fas fa-robot', cssVars: { '--bg-color': '#1e1a2f', '--text-color': '#f0f0f0', '--card-bg': 'rgba(40, 35, 60, 0.8)', '--card-shadow': '0 8px 30px rgba(125, 233, 56, 0.2)', '--border-color': '#5a5278', '--accent-color': '#7de938', '--label-color': '#b0a8d1', '--value-color': '#ffffff', '--control-bg': '#28233c', '--control-border': '#5a5278', '--control-text': '#e0e0e0', '--control-hover-bg': 'rgba(90, 82, 120, 0.7)', '--control-active-bg': '#7de938', '--control-active-text': '#1e1a2f', '--status-green': '#7de938', '--gradient-start': '#7de938', '--gradient-mid': '#8a3ffc', '--gradient-end': '#7de938', '--font-family-main': "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif" }, chartColors: { hit: 'rgba(125, 233, 56, 0.8)', miss: 'rgba(138, 63, 252, 0.5)', text: '#f0f0f0' }, extraStyles: {'body': 'background-color: #1e1a2f; background-image: radial-gradient(circle, #2e284d 0%, #1e1a2f 70%);'} },
            'monokai': { name: 'Monokai Pro', icon: 'fas fa-code', cssVars: { '--bg-color': '#222324', '--text-color': '#fcfcfa', '--card-bg': 'rgba(45, 46, 47, 0.85)', '--card-shadow': '0 8px 25px rgba(0, 0, 0, 0.5)', '--border-color': '#414344', '--accent-color': '#ff6188', '--label-color': '#8f908a', '--value-color': '#fcfcfa', '--control-bg': '#3a3b3c', '--control-border': '#515252', '--control-text': '#d5d6d2', '--control-hover-bg': '#4a4b4d', '--control-active-bg': '#ff6188', '--control-active-text': '#222324', '--status-green': '#a9dc76', '--gradient-start': '#ff6188', '--gradient-mid': '#a9dc76', '--gradient-end': '#78dce8', '--font-family-main': "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif" }, chartColors: { hit: 'rgba(255, 97, 136, 0.8)', miss: 'rgba(169, 220, 118, 0.6)', text: '#fcfcfa' } },
            'solarized_dark': { name: 'Solarized Dark', icon: 'fas fa-adjust', cssVars: { '--bg-color': '#002b36', '--text-color': '#93a1a1', '--card-bg': 'rgba(7, 54, 66, 0.8)', '--card-shadow': '0 6px 18px rgba(0, 0, 0, 0.4)', '--border-color': '#073642', '--accent-color': '#2aa198', '--label-color': '#657b83', '--value-color': '#eee8d5', '--control-bg': '#073642', '--control-border': '#586e75', '--control-text': '#93a1a1', '--control-hover-bg': 'rgba(88, 110, 117, 0.5)', '--control-active-bg': '#2aa198', '--control-active-text': '#002b36', '--status-green': '#859900', '--gradient-start': '#268bd2', '--gradient-mid': '#2aa198', '--gradient-end': '#b58900', '--font-family-main': "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif" }, chartColors: { hit: 'rgba(42, 161, 152, 0.8)', miss: 'rgba(181, 137, 0, 0.6)', text: '#93a1a1' } },
        };
        
        const cacheConfig = {
            'cache_all': { default: 'cache_all', modeB: 'cache_all_noleak', title: '全部缓存', titleModeB: '全部缓存 (安全模式)' },
            'cache_cn': { default: 'cache_cn', modeB: 'cache_cn', title: '国内缓存' },
            'cache_google': { default: 'cache_google', modeB: 'cache_google_node', title: '国外缓存', titleModeB: '国外缓存 (安全模式)', tooltip: '兼容模式无数据属正常现象，此缓存仅在列表外域名（解析过1次即自动生成规则成为列表内域名）国内dns无ipv4解析结果时才会生效或命中。' },
            'cache_node': { default: 'cache_node', modeB: 'cache_node', title: '节点缓存' }
        };
        const cacheOrder = ['cache_all', 'cache_cn', 'cache_google', 'cache_node']; 
        let visibleCards = JSON.parse(localStorage.getItem('visibleMosdnsCards')) || cacheOrder;

        function setTheme(mode) {
            currentTheme = mode; const theme = themeMap[mode] || themeMap.light;
            D.body.style.backgroundImage = '';

            Object.entries(theme.cssVars).forEach(([key, value]) => D.documentElement.style.setProperty(key, value));
            getById('theme-extra-styles')?.remove();
            if (theme.extraStyles) { const style = createElement('style', '', '', 'theme-extra-styles'); style.textContent = Object.entries(theme.extraStyles).map(([sel, rule]) => `${sel} { ${rule} }`).join('\n'); D.head.appendChild(style); }
            
            const savedBg = localStorage.getItem('customBackgroundUrl');
            if (savedBg) { setBackgroundImage(savedBg); }

            localStorage.setItem('theme', mode);
            updateThemeButtons(mode);
            setTimeout(() => { Object.values(chartInstances).forEach(c => c.destroy()); chartInstances = {}; refreshData(true, true); }, 50);
        }

        function setBackgroundImage(url) {
            D.body.style.backgroundImage = url ? `url('${url.replace(/'/g, "\\'")}')` : '';
            D.body.classList.toggle('custom-background', !!url);
            if (url) { localStorage.setItem('customBackgroundUrl', url); } 
            else { localStorage.removeItem('customBackgroundUrl'); }
        }
        
        function parseMetrics(metricsText, cacheTag) {
            const lines = metricsText.split('\n');
            const metrics = { query_total: 0, hit_total: 0, lazy_hit_total: 0, size_current: 0 };
            const query_str = `mosdns_cache_query_total{tag="${cacheTag}"}`; const hit_str = `mosdns_cache_hit_total{tag="${cacheTag}"}`;
            const lazy_str = `mosdns_cache_lazy_hit_total{tag="${cacheTag}"}`; const size_str = `mosdns_cache_size_current{tag="${cacheTag}"}`;
            lines.forEach(line => {
                if (line.startsWith(query_str)) { metrics.query_total = parseFloat(line.split(' ')[1]) || 0; } 
                else if (line.startsWith(hit_str)) { metrics.hit_total = parseFloat(line.split(' ')[1]) || 0; } 
                else if (line.startsWith(lazy_str)) { metrics.lazy_hit_total = parseFloat(line.split(' ')[1]) || 0; } 
                else if (line.startsWith(size_str)) { metrics.size_current = parseFloat(line.split(' ')[1]) || 0; }
            });
            return metrics;
        }

        function parseSystemMetrics(metricsText) {
            const lines = metricsText.split('\n');
            const systemMetrics = { startTime: 0, cpuTime: 0, residentMemory: 0, heapIdleMemory: 0, threads: 0, openFds: 0, goVersion: "N/A" };
            lines.forEach(line => {
                if (line.startsWith('process_start_time_seconds')) { systemMetrics.startTime = parseFloat(line.split(' ')[1]) || 0; } 
                else if (line.startsWith('process_cpu_seconds_total')) { systemMetrics.cpuTime = parseFloat(line.split(' ')[1]) || 0; } 
                else if (line.startsWith('process_resident_memory_bytes')) { systemMetrics.residentMemory = parseFloat(line.split(' ')[1]) || 0; } 
                else if (line.startsWith('go_memstats_heap_idle_bytes')) { systemMetrics.heapIdleMemory = parseFloat(line.split(' ')[1]) || 0; } 
                else if (line.startsWith('go_threads')) { systemMetrics.threads = parseInt(line.split(' ')[1]) || 0; } 
                else if (line.startsWith('process_open_fds')) { systemMetrics.openFds = parseInt(line.split(' ')[1]) || 0; } 
                else if (line.startsWith('go_info{version="')) { const match = line.match(/go_info{version="([^"]+)"}/); if (match && match[1]) { systemMetrics.goVersion = match[1]; } }
            });
            return systemMetrics;
        }
        
        async function fetchData() {
            if (isRefreshing) return null;
            isRefreshing = true;
            D.body.classList.add('loading');
            try {
                const response = await fetch('/metrics');
                if (!response.ok) throw new Error(`网络响应错误: ${response.statusText} (${response.status})`);
                const text = await response.text();
                const data = { caches: {}, system: {} };
                const systemMetrics = parseSystemMetrics(text);
                
                cacheOrder.forEach(key => {
                    const config = cacheConfig[key];
                    const effectiveTag = coreMode === 'B' ? config.modeB : config.default;
                    const metrics = parseMetrics(text, effectiveTag);
                    data.caches[key] = { ...metrics, hit_rate: metrics.query_total > 0 ? ((metrics.hit_total / metrics.query_total) * 100).toFixed(2) + '%' : '0.00%', lazy_hit_rate: metrics.query_total > 0 ? ((metrics.lazy_hit_total / metrics.query_total) * 100).toFixed(2) + '%' : '0.00%' };
                });
                
                data.system = { start_time: systemMetrics.startTime ? new Date(systemMetrics.startTime * 1000).toLocaleString() : 'N/A', cpu_time: `${systemMetrics.cpuTime.toFixed(2)} 秒`, resident_memory: `${(systemMetrics.residentMemory / 1024 / 1024).toFixed(2)} MB`, heap_idle_memory: `${(systemMetrics.heapIdleMemory / 1024 / 1024).toFixed(2)} MB`, go_version: systemMetrics.goVersion, threads: systemMetrics.threads, open_fds: systemMetrics.openFds };
                return data;
            } catch (error) {
                console.error('获取 /metrics 失败:', error);
                return { error: error.message };
            } finally {
                isRefreshing = false;
                D.body.classList.remove('loading');
            }
        }
        
        function createCacheCard(tag, titleHTML) { const c = createElement('div', 'card'); c.dataset.tag = tag; c.innerHTML = `<h2><i class="fas fa-server"></i><span class="title-text">${titleHTML}</span><span class="status-dot" id="status-dot-${tag}"></span></h2><div class="card-title-gradient-bar"></div><div class="metrics-container" id="metrics-${tag}"></div><div class="charts" id="charts-${tag}"><div class="chart-container"><canvas id="chart-hit-${tag}"></canvas></div><div class="chart-container"><canvas id="chart-lazy-${tag}"></canvas></div></div>`; return c; }
        function createOrUpdatePieChart(id, title, hit, total) { const ctx = getById(id); if (!ctx) return; const c = themeMap[currentTheme]?.chartColors || themeMap.light.chartColors; const d = { labels: ['命中', '未命中'], datasets: [{ data: [hit, Math.max(0, total - hit)], backgroundColor: [c.hit, c.miss], borderWidth: 0 }] }; const o = { plugins: { title: { display: true, text: title, color: c.text, font: { size: 12, weight: '500' } }, datalabels: { color: c.text, formatter: (v, ctx) => { const s = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); return s > 0 && v / s > 0.05 ? `${(v / s * 100).toFixed(0)}%` : ''; } } } }; if (chartInstances[id]) { chartInstances[id].data = d; chartInstances[id].options = o; chartInstances[id].update('none'); } else { chartInstances[id] = new Chart(ctx, { type: 'doughnut', data: d, options: o }); } }
        
        function updateMetrics(containerId, metricsData) {
            const container = getById(containerId);
            if (!container) return;
            container.innerHTML = '';
            metricsData.forEach(m => {
                const itemWrapper = createElement('div', 'metric-item');
                const labelEl = createElement('div', 'metric-label');
                labelEl.innerHTML = `<i class="fas ${iconMap[m.label] || 'fa-question-circle'}"></i> <span>${m.label}</span>`;
                const valueEl = createElement('div', `metric-value${m.accent ? ' accent' : ''}`);
                valueEl.innerText = (m.numericValue !== undefined) ? formatNumber(m.numericValue) : m.value;

                itemWrapper.append(labelEl, valueEl);
                container.appendChild(itemWrapper);
            });
        }
        
        async function refreshData(forceRebuild = false, updateCharts = false) {
            await updateCoreModeStatus();
            const data = await fetchData();
            if (data && data.error) { getById('main-content').innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i><p>无法连接到 MosDNS API。</p><small>${data.error}</small></div>`; if (autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; getById('auto-refresh-toggle').checked = false; localStorage.setItem('autoRefresh', 'false'); } return; }
            if (!data) return;
            if (forceRebuild) { getById('main-content').innerHTML = ''; Object.values(chartInstances).forEach(c => c.destroy()); chartInstances = {}; }
            
            cacheOrder.forEach(key => {
                let card = D.querySelector(`.card[data-tag="${key}"]`);
                const config = cacheConfig[key];
                let title = coreMode === 'B' ? (config.titleModeB || config.title) : config.title;
                const shouldBeVisible = visibleCards.includes(key);

                let titleHTML = `<span>${title}</span>`;
                if (config.tooltip) {
                    titleHTML += `<i class="fas fa-info-circle info-tooltip-icon" data-tooltip="${config.tooltip}"></i>`;
                }

                if (shouldBeVisible && !card) { card = createCacheCard(key, titleHTML); getById('main-content').appendChild(card); } 
                else if (card && !shouldBeVisible) { card.remove(); return; }
                else if (card && shouldBeVisible) { card.querySelector('.title-text').innerHTML = titleHTML; }
                
                const cardData = data.caches[key];
                if (card && cardData && shouldBeVisible) {
                    card.classList.add('visible');
                    const metricsContainer = getById(`metrics-${key}`);
                    metricsContainer.innerHTML = ''; 
                    [{ label: '请求总数', numericValue: cardData.query_total }, { label: '缓存命中', numericValue: cardData.hit_total }, { label: '过期缓存命中', numericValue: cardData.lazy_hit_total }, { label: '缓存命中率', value: cardData.hit_rate, accent: true }, { label: '过期缓存命中率', value: cardData.lazy_hit_rate, accent: true }, { label: '缓存条目数', numericValue: cardData.size_current }, ].forEach(m => {
                        const p = createElement('div', 'metric-label');
                        p.innerHTML = `<i class="fas ${iconMap[m.label] || 'fa-question-circle'}"></i> <span>${m.label}:</span>`;
                        const v = createElement('div', `metric-value${m.accent ? ' accent' : ''}`);
                        v.innerText = (m.numericValue !== undefined) ? formatNumber(m.numericValue) : m.value;
                        metricsContainer.append(p, v);
                    });
                    
                    getById(`status-dot-${key}`).classList.toggle('status-green', cardData.query_total > 0); getById(`status-dot-${key}`).classList.toggle('status-yellow', cardData.query_total === 0);
                    getById(`charts-${key}`).style.display = cardData.query_total > 0 ? 'flex' : 'none';
                    if ((forceRebuild || updateCharts) && cardData.query_total > 0) { createOrUpdatePieChart(`chart-hit-${key}`, '命中', cardData.hit_total, cardData.query_total); createOrUpdatePieChart(`chart-lazy-${key}`, '过期命中', cardData.lazy_hit_total, cardData.query_total); }
                }
            });
            updateMetrics('metrics-system', [{ label: '启动时间', value: data.system.start_time }, { label: 'CPU 时间', value: data.system.cpu_time }, { label: '常驻内存 (RSS)', value: data.system.resident_memory }, { label: '待用堆内存 (Idle)', value: data.system.heap_idle_memory }, { label: 'Go 版本', value: data.system.go_version, accent: true }, { label: '线程数', numericValue: data.system.threads }, { label: '打开文件描述符', numericValue: data.system.open_fds }, ]);
            const lastUpdatedEl = getById('last_updated');
            if(lastUpdatedEl) lastUpdatedEl.innerHTML = `<i class="fas fa-clock"></i> 最后更新: ${new Date().toLocaleTimeString()}`;
            
            initializeTooltips();
        }
        
        function setupCardToggles() { 
            const container = getById('card-toggles');
            container.innerHTML = ''; 
            cacheOrder.forEach(tag => { 
                const toggleId = `card-toggle-${tag}`;
                const label = createElement('label', 'control-base-label');
                label.htmlFor = toggleId;

                const input = createElement('input', '', '', toggleId);
                input.type = 'checkbox'; 
                input.dataset.tag = tag; 
                input.checked = visibleCards.includes(tag); 
                
                input.onchange = (e) => { 
                    const currentTag = e.target.dataset.tag; 
                    if (e.target.checked) { 
                        if (!visibleCards.includes(currentTag)) visibleCards.push(currentTag); 
                    } else { 
                        visibleCards = visibleCards.filter(t => t !== currentTag); 
                    } 
                    localStorage.setItem('visibleMosdnsCards', JSON.stringify(visibleCards)); 
                    refreshData(true, true); 
                }; 
                
                label.append(input, createElement('span', 'toggle-label-text', cacheConfig[tag].title)); 
                container.appendChild(label); 
            }); 
        }
        
        function updateThemeButtons(activeMode) {
            const ts = getById('theme-selector'); ts.innerHTML = '';
            Object.keys(themeMap).forEach(mode => {
                const t = themeMap[mode]; const btn = createElement('button', 'control-base-label');
                btn.dataset.theme = mode; btn.innerHTML = `<i class="${t.icon}"></i> ${t.name}`;
                if (mode === activeMode) btn.classList.add('active');
                btn.onclick = () => setTheme(mode); ts.appendChild(btn);
            });
        }
        
        function throttle(func, limit) { let inThrottle; return function() { const args = arguments; const context = this; if (!inThrottle) { func.apply(context, args); inThrottle = true; setTimeout(() => inThrottle = false, limit); } } }

        function showErrorModal(message) {
            getById('error-modal-message').textContent = message || '发生未知错误。';
            getById('error-modal').classList.add('visible');
        }
        function hideErrorModal() { getById('error-modal').classList.remove('visible'); }
        async function updateCoreModeStatus() {
            try {
                const response = await fetch('/plugins/switch3/show');
                if (response.ok) coreMode = (await response.text()).trim();
            } catch (e) { console.error("无法获取核心模式状态:", e); }
        }
        
        async function postApi(path, payload) {
            const response = await fetch(path, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const errorText = await response.text(); throw new Error(errorText || `请求失败，状态码: ${response.status}`); }
            return response;
        }

        async function initializeSwitchManagementTab() {
            const container = getById('config-mgmt-container');
            container.innerHTML = '<div id="loading-spinner" style="display: block; margin: 2rem auto;"></div>';
            isMgmtTabInitialized.config = false;
            try {
                await updateCoreModeStatus();
                const fetchPromises = switchProfiles.map(p => fetch(`/plugins/${p.tag}/show`));
                const results = await Promise.allSettled(fetchPromises);
                
                const statuses = {};
                for (let i = 0; i < results.length; i++) {
                    const result = results[i];
                    const profile = switchProfiles[i];
                    if (result.status === 'fulfilled' && result.value.ok) {
                        statuses[profile.tag] = (await result.value.text()).trim();
                    } else {
                        const reason = result.reason ? result.reason.message : (result.value ? `HTTP ${result.value.status}` : 'Unknown Error');
                        console.error(`获取 ${profile.tag} 状态失败:`, reason);
                        statuses[profile.tag] = 'error';
                    }
                }
                
                container.innerHTML = ''; 
                const masterProfile = switchProfiles.find(p => p.modes);
                if (masterProfile) {
                    const masterCard = createElement('div', 'master-switch-card');
                    const currentState = statuses[masterProfile.tag];
                    const titleHTML = `<h5 class="subsection-title"><i class="fas fa-satellite-dish"></i> <span>${masterProfile.name}</span>${masterProfile.tip ? `<i class="fas fa-info-circle info-tooltip-icon" data-tooltip="${masterProfile.tip}"></i>` : ''}</h5>`;
                    
                    masterCard.innerHTML = titleHTML + 
                        (currentState === 'error' ? `<p class="error-message" style="padding:0;background:none;border:none;text-align:center;color:var(--error-color);">获取状态失败</p>` :
                        `<div class="segmented-control">
                            <div class="glider" style="transform: translateX(${currentState === 'A' ? '0%' : '100%'});"></div>
                            ${Object.entries(masterProfile.modes).map(([val, {name, icon}]) => `<button class="${currentState===val?'active':''}" data-value="${val}" data-switch-tag="${masterProfile.tag}"><i class="fas ${icon}"></i> ${name}</button>`).join('')}
                        </div>`);
                    if (currentState !== 'error') masterCard.querySelectorAll('.segmented-control button').forEach(btn => { btn.onclick = () => handleMasterSwitch(btn); });
                    container.appendChild(masterCard);
                }

                const secondaryContainer = createElement('div', 'secondary-switches-list');
                
                switchProfiles.filter(p => !p.modes).forEach(profile => {
                    const card = createElement('div', 'switch-card', '', `switch-card-${profile.tag}`);
                    const currentState = statuses[profile.tag];
                    const isChecked = currentState === profile.valueForOn;
                    const switchId = `switch-input-${profile.tag}`;
                    const titleHTML = `<h4><span>${profile.name}</span>${profile.tip ? `<i class="fas fa-info-circle info-tooltip-icon" data-tooltip="${profile.tip}"></i>` : ''}</h4>`;
                    
                    card.innerHTML = currentState === 'error' ? `<i class="icon-area fas ${profile.icon}"></i><div class="switch-content">${titleHTML}<p style="color:var(--error-color);">获取状态失败</p></div>`
                        : `<i class="icon-area fas ${profile.icon}"></i>
                        <div class="switch-content">${titleHTML}<p>${profile.desc}</p></div>
                        <div class="switch-control">
                            <input type="checkbox" id="${switchId}" class="apple-switch-input" data-switch-tag="${profile.tag}" ${isChecked ? 'checked' : ''}>
                            <label for="${switchId}" class="apple-switch-slider"></label>
                            <div class="mini-loader"></div>
                        </div>`;
                    if(currentState !== 'error') card.querySelector('input[type="checkbox"]').onchange = (e) => handleSecondarySwitch(e.target);
                    secondaryContainer.appendChild(card);
                });
                if (secondaryContainer.children.length > 0) container.appendChild(secondaryContainer);
                isMgmtTabInitialized.config = true;
                
                initializeTooltips();
            } catch (error) {
                console.error("Switch tab initialization error:", error);
                container.innerHTML = `<div class="error-message" style="margin: 0;"><p>加载开关状态时发生意外错误</p><small>${error.message}</small></div>`;
            }
        }
        
        async function handleMasterSwitch(button) {
            if (button.classList.contains('active')) return;
            const tag = button.dataset.switchTag, valueToPost = button.dataset.value, control = button.parentElement;
            control.classList.add('loading');
            try {
                await postApi(`/plugins/${tag}/post`, { value: valueToPost });
                coreMode = valueToPost; 
                try {
                    const requests = ruleListPaths.map(path => fetch(`/plugins/${path}`));
                    await Promise.all(requests.map(async p => {
                        const res = await p;
                        if (!res.ok) throw new Error(`清空规则失败于: ${res.url} (${res.status})`);
                    }));
                    showToast('核心模式切换成功，已自动清空分流规则。');
                } catch(flushError) {
                    console.error("自动清空分流规则失败:", flushError);
                    showToast(`核心模式已切换，但自动清空分流规则失败。`, 'error');
                }

                await refreshData(true, true);
            } catch (error) {
                showToast(`切换核心模式失败！`, 'error');
                showErrorModal(error.message);
            } finally {
                await initializeSwitchManagementTab();
            }
        }

        async function handleSecondarySwitch(checkbox) {
            const tag = checkbox.dataset.switchTag;
            const card = getById(`switch-card-${tag}`); card.classList.add('loading'); checkbox.disabled = true;
            const profile = switchProfiles.find(p => p.tag === tag);
            const valueToPost = checkbox.checked ? profile.valueForOn : (profile.valueForOn === 'A' ? 'B' : 'A');
            try {
                await postApi(`/plugins/${tag}/post`, { value: valueToPost });
                showToast(`“${profile.name}” 已${checkbox.checked ? '启用' : '禁用'}`);
            } catch (error) {
                showToast(`切换 "${profile.name}" 失败`, 'error');
                showErrorModal(e.message);
            } finally {
                await initializeSwitchManagementTab();
            }
        }

        async function initializeListManagementTab() {
            const container = getById('list-mgmt-container');
            container.innerHTML = '<div id="loading-spinner" style="display: block; margin: 2rem auto;"></div>';
            isMgmtTabInitialized.list = false;

            const allProfiles = [...ipSetProfiles, ...domainSetProfiles, ...hostsProfiles];
            container.innerHTML = `<div class="list-mgmt-layout"><div class="list-submenu"></div><div class="list-content-area"></div></div>`;
            const submenu = container.querySelector('.list-submenu');
            const contentArea = container.querySelector('.list-content-area');

            allProfiles.forEach(profile => {
                submenu.innerHTML += `<div class="list-submenu-item" data-tag="${profile.tag}"><i class="icon-area fas ${profile.icon}"></i> <span>${profile.name}</span></div>`;
                contentArea.innerHTML += `<div class="list-mgmt-card" id="list-card-${profile.tag}"><textarea id="textarea-${profile.tag}" placeholder="正在加载内容..." spellcheck="false"></textarea><div class="list-mgmt-footer"><div id="status-${profile.tag}" class="list-status"><span class="status-text"></span></div><div class="action-area"><button id="save-btn-${profile.tag}"><i class="fas fa-save"></i> 保存更改</button></div></div></div>`;
            });

            const submenuItems = submenu.querySelectorAll('.list-submenu-item');
            const contentCards = contentArea.querySelectorAll('.list-mgmt-card');
            submenuItems.forEach(item => {
                item.addEventListener('click', () => {
                    submenuItems.forEach(i => i.classList.remove('active'));
                    contentCards.forEach(c => c.classList.remove('active'));
                    item.classList.add('active');
                    getById(`list-card-${item.dataset.tag}`).classList.add('active');
                });
            });

            if (submenuItems.length > 0) submenuItems[0].click();
            
            const fetchPromises = allProfiles.map(profile => 
                fetch(`/plugins/${profile.tag}/show`).then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.text();
                }).then(text => ({ status: 'fulfilled', value: text, profile }))
                  .catch(error => ({ status: 'rejected', reason: error, profile }))
            );

            const results = await Promise.all(fetchPromises);

            results.forEach(result => {
                const { profile } = result;
                const textarea = getById(`textarea-${profile.tag}`);
                const statusEl = getById(`status-${profile.tag}`).querySelector('.status-text');
                const saveBtn = getById(`save-btn-${profile.tag}`);

                if (result.status === 'fulfilled') {
                    const fullText = result.value;
                    const lines = fullText.trim() === '' ? [] : fullText.split('\n');
                    
                    if (lines.length > MAX_LINES_TO_DISPLAY) {
                        textarea.value = lines.slice(0, MAX_LINES_TO_DISPLAY).join('\n');
                        const statusContainer = getById(`status-${profile.tag}`);
                        const downloadBtn = createElement('button', 'btn download-btn');
                        downloadBtn.innerHTML = `<i class="fas fa-download"></i> 下载完整列表`;
                        downloadBtn.onclick = () => {
                            const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
                            const url = URL.createObjectURL(blob);
                            const a = createElement('a'); a.href = url; a.download = `${profile.tag}_full_list.txt`;
                            D.body.appendChild(a); a.click(); D.body.removeChild(a); URL.revokeObjectURL(url);
                        };
                        if(!statusContainer.querySelector('.download-btn')) statusContainer.appendChild(downloadBtn);
                        statusEl.textContent = `已截断显示前 ${MAX_LINES_TO_DISPLAY} 行 (共 ${lines.length} 行)`;
                    } else if (lines.length === 0) {
                        textarea.value = '';
                        textarea.placeholder = '文件内容为空';
                        statusEl.textContent = '列表为空';
                    } else {
                        textarea.value = fullText.trim();
                        statusEl.textContent = `加载于 ${new Date().toLocaleTimeString()} (共 ${lines.length} 行)`;
                    }
                } else {
                    textarea.value = `加载失败: ${result.reason.message}`;
                    textarea.placeholder = '加载失败';
                    statusEl.textContent = `加载失败`;
                    statusEl.classList.add('error');
                    if (saveBtn) saveBtn.disabled = true;
                }

                if (saveBtn) saveBtn.onclick = () => handleListSave(profile);
            });
            
            isMgmtTabInitialized.list = true;
        }
        
        async function handleListSave(profile) {
            const textarea = getById(`textarea-${profile.tag}`);
            const statusEl = getById(`status-${profile.tag}`).querySelector('.status-text');
            try {
                statusEl.textContent = '正在保存...'; statusEl.classList.remove('error');
                const values = textarea.value.split('\n').map(s => s.trim()).filter(Boolean);
                await postApi(`/plugins/${profile.tag}/post`, { values });
                showToast(`“${profile.name}” 保存成功！`);
                statusEl.textContent = `保存成功! ${new Date().toLocaleTimeString()} (共 ${values.length} 行)`;
            } catch (e) {
                showToast(`保存 “${profile.name}” 失败`, 'error');
                showErrorModal(e.message);
                statusEl.textContent = '保存失败';
                statusEl.classList.add('error');
            }
        }
        
        function initializeTooltips() {
            const tooltipEl = getById('global-tooltip');
            if (!tooltipEl) return;
            
            const tooltipIcons = D.querySelectorAll('[data-tooltip]');
            tooltipIcons.forEach(icon => {
                icon.onmouseenter = (e) => {
                    tooltipEl.textContent = icon.dataset.tooltip;
                    tooltipEl.classList.add('active');
                    
                    const iconRect = icon.getBoundingClientRect();
                    
                    let top = iconRect.top - 8;
                    let left = iconRect.left + (iconRect.width / 2);
                    
                    tooltipEl.style.left = `${left}px`;
                    tooltipEl.style.top = `${top}px`;
                    
                    const tooltipRect = tooltipEl.getBoundingClientRect();
                    top = iconRect.top - tooltipRect.height - 8;
                    left = iconRect.left + (iconRect.width / 2) - (tooltipRect.width / 2);

                    if (top < 10) top = iconRect.bottom + 8;
                    if (left < 10) left = 10;
                    if (left + tooltipRect.width > window.innerWidth - 10) {
                        left = window.innerWidth - tooltipRect.width - 10;
                    }

                    tooltipEl.style.top = `${top}px`;
                    tooltipEl.style.left = `${left}px`;
                };

                icon.onmouseleave = () => {
                    tooltipEl.classList.remove('active');
                };
            });
        }
        
        async function saveAllRulesAndNotify() {
            try {
                const paths = ['top_domains/save','my_fakeiplist/save', 'my_nodenov4list/save', 'my_nodenov6list/save', 'my_notinlist/save', 'my_nov4list/save', 'my_nov6list/save', 'my_realiplist/save'];
                showToast('正在保存分流规则...');
                const requests = paths.map(p => fetch(`/plugins/${p}`));
                
                await Promise.all(requests.map(async p => {
                    const res = await p;
                    if (!res.ok) {
                        const errorText = await res.text();
                        throw new Error(`保存规则失败于 ${res.url}: ${errorText || res.statusText}`);
                    }
                }));

                showToast('分流规则已成功保存。', 'success');
                return true; 
            } catch (e) {
                showToast('保存分流规则时发生错误！', 'error');
                showErrorModal(e.message);
                return false; 
            }
        }
        
        function renderTableData(entries) {
            const dataModalBody = getById('data-modal-body');
            const dataModalInfo = getById('data-modal-info');
            
            dataModalBody.innerHTML = ''; 

            if (entries.length === 0) {
                dataModalBody.innerHTML = '<p style="text-align: center; color: var(--label-color);">无数据或无匹配条目。</p>';
                dataModalInfo.textContent = `总条目: ${currentModalData.totalCount} (过滤后: 0), 加载耗时: ${currentModalData.loadTime}ms`;
                return;
            }
            
            const table = createElement('table', 'data-table');
            table.innerHTML = `<thead><tr><th>Count / ID</th><th>Domain / Value</th></tr></thead>`;
            const tbody = createElement('tbody');

            entries.forEach(item => {
                const tr = createElement('tr');
                tr.innerHTML = `<td>${item.id}</td><td>${item.value}</td>`;
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            dataModalBody.appendChild(table);
            dataModalInfo.textContent = `总条目: ${currentModalData.totalCount} (过滤后: ${entries.length}), 加载耗时: ${currentModalData.loadTime}ms`;
        }

        function renderAccordionData(entries) {
            const dataModalBody = getById('data-modal-body');
            const dataModalInfo = getById('data-modal-info');

            dataModalBody.innerHTML = '';
            if (entries.length === 0) {
                dataModalBody.innerHTML = '<p style="text-align: center; color: var(--label-color);">缓存为空或无匹配条目。</p>';
                dataModalInfo.textContent = `总条目: ${currentModalData.totalCount} (过滤后: 0), 加载耗时: ${currentModalData.loadTime}ms`;
                return;
            }

            const accordionContainer = createElement('div', 'cache-accordion-container');
            entries.forEach((entry, idx) => {
                const entryWrapper = createElement('div', 'cache-entry-accordion');
                const header = createElement('button', 'accordion-header');
                header.textContent = entry.headerTitle;

                const panel = createElement('div', 'accordion-panel');
                entryWrapper.appendChild(header);
                entryWrapper.appendChild(panel);
                accordionContainer.appendChild(entryWrapper);
                
                header.addEventListener('click', () => {
                    const isActive = header.classList.toggle('active');
                    panel.classList.toggle('active');
                    if (isActive && panel.innerHTML === '') {
                        const dnsMsgIndex = entry.fullText.indexOf('DNS Message:');
                        const metadataText = dnsMsgIndex !== -1 ? entry.fullText.substring(0, dnsMsgIndex) : entry.fullText;
                        const dnsMessageText = dnsMsgIndex !== -1 ? entry.fullText.substring(dnsMsgIndex) : 'DNS Message not found.';

                        const metadataTable = createElement('table', 'data-table metadata-table');
                        const tbody = createElement('tbody');
                        metadataText.trim().split('\n').forEach(line => {
                            const parts = line.match(/^([^:]+):\s*(.*)$/);
                            if (parts) {
                               tbody.innerHTML += `<tr><td>${parts[1].trim()}</td><td>${parts[2].trim()}</td></tr>`;
                            }
                        });
                        metadataTable.appendChild(tbody);
                        
                        const pre = createElement('pre', '', dnsMessageText.trim());
                        
                        panel.appendChild(metadataTable);
                        panel.appendChild(pre);
                    }

                    if (isActive) {
                        panel.style.maxHeight = panel.scrollHeight + "px";
                    } else {
                        panel.style.maxHeight = null;
                    }
                });
            });
            dataModalBody.appendChild(accordionContainer);
            dataModalInfo.textContent = `总条目: ${currentModalData.totalCount} (过滤后: ${entries.length}), 加载耗时: ${currentModalData.loadTime}ms`;
        }

        async function displayCacheDataInModal(url, title) {
            const dataModal = getById('data-view-modal');
            const dataModalTitle = getById('data-modal-title');
            const dataModalBody = getById('data-modal-body');
            const dataModalInfo = getById('data-modal-info');
            
            dataModalTitle.textContent = title;
            dataModalBody.innerHTML = '<div id="loading-spinner" style="display: block; margin: 4rem auto;"></div>';
            dataModalInfo.textContent = '正在加载...';
            dataModal.classList.add('visible');

            dataModalSearchInput.value = '';
            dataModalSearchInput.oninput = null; 
            
            try {
                const startTime = performance.now();
                const response = await fetch(url);
                if (!response.ok) throw new Error(`网络响应错误: ${response.status} ${response.statusText}`);
                
                const text = await response.text();
                const entries = text.trim().split('----- Cache Entry -----').filter(entry => entry.trim() !== '');
                const endTime = performance.now();

                currentModalData.type = 'accordion';
                currentModalData.rawEntries = entries.map((entryText, index) => {
                    const questionMatch = entryText.match(/;; QUESTION SECTION:\s*;\s*([^\s]+)/);
                    const keyMatch = entryText.match(/Key:\s*([^\s]+)\s+\d+\s+([A-Z\d]+)/);
                    let headerTitle;
                    if (questionMatch && keyMatch) {
                        headerTitle = `${questionMatch[1]}` + (keyMatch[2] ? ` (${keyMatch[2]})` : '');
                    } else if (questionMatch) {
                        headerTitle = `${questionMatch[1]}`;
                    } else {
                        headerTitle = `缓存条目 #${index + 1}`;
                    }
                    return {
                        headerTitle: headerTitle,
                        fullText: entryText,
                        index: index 
                    };
                });
                currentModalData.totalCount = currentModalData.rawEntries.length;
                currentModalData.loadTime = (endTime - startTime).toFixed(2);
                currentModalData.filteredEntries = currentModalData.rawEntries;

                renderAccordionData(currentModalData.filteredEntries);

                dataModalSearchInput.oninput = () => {
                    const searchTerm = dataModalSearchInput.value.toLowerCase();
                    currentModalData.filteredEntries = currentModalData.rawEntries.filter(item => 
                        item.headerTitle.toLowerCase().includes(searchTerm)
                    );
                    renderAccordionData(currentModalData.filteredEntries);
                };

            } catch (error) {
                console.error('获取缓存数据失败:', error);
                dataModalBody.innerHTML = `<p class="error-message" style="margin: 0; padding: 2rem;">获取数据失败: ${error.message}</p>`;
                dataModalInfo.textContent = `加载失败: ${error.message}`;
            }
        }

        async function displayDataInModal(url, title) {
            const dataModal = getById('data-view-modal');
            const dataModalTitle = getById('data-modal-title');
            const dataModalBody = getById('data-modal-body');
            const dataModalInfo = getById('data-modal-info');
            
            dataModalTitle.textContent = title;
            dataModalBody.innerHTML = '<div id="loading-spinner" style="display: block; margin: 4rem auto;"></div>';
            dataModalInfo.textContent = '正在加载...';
            dataModal.classList.add('visible');

            dataModalSearchInput.value = '';
            dataModalSearchInput.oninput = null;

            try {
                const startTime = performance.now();
                const response = await fetch(url);
                if (!response.ok) throw new Error(`网络响应错误: ${response.status} ${response.statusText}`);
                
                const text = await response.text();
                const lines = text.trim().split('\n').filter(Boolean);
                const endTime = performance.now();

                currentModalData.type = 'table';
                currentModalData.rawEntries = lines.map(line => {
                    const parts = line.trim().match(/^(\S+)\s+(.*)$/);
                    return {
                        id: parts ? parts[1] : '-',
                        value: parts ? parts[2] : line,
                        originalLine: line
                    };
                });
                currentModalData.totalCount = currentModalData.rawEntries.length;
                currentModalData.loadTime = (endTime - startTime).toFixed(2);
                currentModalData.filteredEntries = currentModalData.rawEntries;

                renderTableData(currentModalData.filteredEntries);

                dataModalSearchInput.oninput = () => {
                    const searchTerm = dataModalSearchInput.value.toLowerCase();
                    currentModalData.filteredEntries = currentModalData.rawEntries.filter(item => 
                        item.value.toLowerCase().includes(searchTerm)
                    );
                    renderTableData(currentModalData.filteredEntries);
                };

            } catch (error) {
                console.error('获取数据失败:', error);
                dataModalBody.innerHTML = `<p class="error-message" style="margin: 0; padding: 2rem;">获取数据失败: ${error.message}</p>`;
                dataModalInfo.textContent = `加载失败: ${error.message}`;
            }
        }

        function setupEventListeners() {
            getById('refresh-now-btn').onclick = () => { refreshData(false, true); showToast('数据已手动刷新'); };
            const autoRefreshToggle = getById('auto-refresh-toggle');
            autoRefreshToggle.onchange = (e) => { const isEnabled = e.target.checked; localStorage.setItem('autoRefresh', isEnabled); if (isEnabled) { if (!autoRefreshTimer) autoRefreshTimer = setInterval(() => refreshData(false, true), REFRESH_INTERVAL); } else if (autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; } };

            const createApiAction = (btnId, paths, msg, successMsg) => {
                getById(btnId).addEventListener('click', async () => {
                    if (msg && !confirm(msg)) return;
                    try {
                        const requests = paths.map(p => fetch(`/plugins/${p}`));
                        await Promise.all(requests.map(async p => {
                            const res = await p;
                            if (!res.ok) throw new Error(`操作失败于: ${res.url} (${res.status})`);
                        }));
                        showToast(successMsg);
                    } catch (e) {
                        showToast('操作失败', 'error');
                        showErrorModal(e.message);
                    }
                });
            };
            getById('save-rules-btn').addEventListener('click', () => { if (confirm('确定保存所有分流规则吗?')) { saveAllRulesAndNotify(); } });
            createApiAction('flush-rules-btn', ruleListPaths, '【危险操作】确定清空所有分流规则吗?', '分流规则已清空。');
            getById('flush-cache-btn').addEventListener('click', async () => { if (!confirm('确定清空全部缓存吗? 此操作将根据当前核心运行模式清空对应的缓存。')) { return; } const cacheToFlush = coreMode === 'B' ? 'cache_all_noleak' : 'cache_all'; const path = `/plugins/${cacheToFlush}/flush`; try { const response = await fetch(path); if (!response.ok) { const errorText = await response.text(); throw new Error(`清空缓存失败于 ${path}: ${errorText || response.statusText}`); } showToast('全部缓存已清空，正在刷新数据...', 'success'); await refreshData(false, true); } catch (e) { showToast('清空缓存操作失败！', 'error'); showErrorModal(e.message); } });
            getById('restart-mosdns-btn').onclick = async () => { if (confirm('【危险操作】此操作将首先保存所有分流规则，然后重启 MosDNS。确定要继续吗?')) { const saveSuccess = await saveAllRulesAndNotify(); if (saveSuccess) { showToast('规则已保存，正在发送重启命令...', 'success'); try { const response = await fetch('/plugins/my_fakeiplist/restartall'); if (!response.ok) { const errorText = await response.text(); throw new Error(errorText || `重启命令请求失败，状态码: ${response.status}`); } showToast('MosDNS 正在重启，页面即将刷新...'); setTimeout(() => location.reload(), 2000); } catch (e) { showToast('重启命令发送失败', 'error'); showErrorModal(e.message); } } else { showToast('由于规则保存失败，重启操作已取消。', 'error'); } } };getById('dns-log-page-btn').onclick = () => { const url = `http://${window.location.hostname}:${window.location.port}/log`; window.open(url, '_blank'); };
            
            const showEndpoints = { '请求排行': 'top_domains','fakeip 域名': 'my_fakeiplist', 'realip 域名': 'my_realiplist', '无 V4 域名': 'my_nov4list', '无 V6 域名': 'my_nov6list', '全部缓存（兼容）': 'cache_all', '全部缓存（安全）': 'cache_all_noleak','国内缓存': 'cache_cn', '国外缓存（兼容）': 'cache_google', '国外缓存（安全）': 'cache_google_node','节点缓存': 'cache_node' };
            const dvContainer = getById('data-view-buttons'); dvContainer.innerHTML = ''; 
            Object.entries(showEndpoints).forEach(([name, path]) => { const btn = createElement('button', 'btn'); btn.textContent = name; btn.onclick = () => { if (path.startsWith('cache_')) { displayCacheDataInModal(`/plugins/${path}/show`, name); } else { displayDataInModal(`/plugins/${path}/show`, name); } }; dvContainer.appendChild(btn); });
            
            const tabButtons = D.querySelectorAll('.tab-button');
            const tabContents = D.querySelectorAll('.control-section-body .tab-content');
            tabButtons.forEach(button => { button.addEventListener('click', () => { tabButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); const targetTabId = `tab-${button.dataset.tab}`; tabContents.forEach(content => content.classList.toggle('active', content.id === targetTabId)); if (button.dataset.tab === 'config-mgmt' && !isMgmtTabInitialized.config) initializeSwitchManagementTab(); if (button.dataset.tab === 'list-mgmt' && !isMgmtTabInitialized.list) initializeListManagementTab(); }); });
            
            getById('set-bg-btn').onclick = () => { const url = prompt('请输入背景图片的 URL 或本地绝对路径:', localStorage.getItem('customBackgroundUrl') || ''); if(url !== null) setBackgroundImage(url); };
            getById('remove-bg-btn').onclick = () => { if(confirm('确定移除自定义背景吗?')) setBackgroundImage(''); };
            
            const blurToggle = getById('blur-toggle'); const blurSlider = getById('blur-slider');
            const setBlur = (value) => D.documentElement.style.setProperty('--glass-blur-strength', `${value}px`);
            blurToggle.onchange = () => { const isEnabled = blurToggle.checked; blurSlider.disabled = !isEnabled; const value = isEnabled ? blurSlider.value : 0; setBlur(value); localStorage.setItem('blurEnabled', isEnabled); };
            blurSlider.addEventListener('input', throttle(() => setBlur(blurSlider.value), 50));
            blurSlider.onchange = () => localStorage.setItem('blurStrength', blurSlider.value);
            
            const dataModal = getById('data-view-modal');
            const hideDataModal = () => { dataModal.classList.remove('visible'); if (dataModalSearchInput) { dataModalSearchInput.value = ''; dataModalSearchInput.oninput = null; } currentModalData = { type: null, rawEntries: [], filteredEntries: [], totalCount: 0, loadTime: 0 }; getById('data-modal-info').textContent = ''; };
            getById('data-modal-close').onclick = hideDataModal;
            dataModal.onclick = (e) => { if(e.target === dataModal) hideDataModal(); };

            getById('error-modal-close').onclick = hideErrorModal;
            getById('error-modal').onclick = (e) => { if(e.target === getById('error-modal')) hideErrorModal(); };

            const mosdnsHost = ''; 
            const startCaptureBtn = getById('start-capture-btn');
            const captureDurationInput = getById('capture-duration-input');
            const getLogsBtn = getById('get-logs-btn');

            startCaptureBtn.addEventListener('click', () => {
                const duration = parseInt(captureDurationInput.value, 10);
                if (isNaN(duration) || duration < 1 || duration > 600) { alert('请输入 1 到 600 之间的秒数。'); return; }
                startCaptureBtn.disabled = true; startCaptureBtn.classList.add('active'); startCaptureBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 采集中...`;
                fetch(`${mosdnsHost}/api/v1/capture/start`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ duration_seconds: duration }) })
                .then(response => { if (!response.ok) throw new Error('启动采集失败'); return response.text(); })
                .then(text => { showToast(text, 'success'); setTimeout(() => { startCaptureBtn.disabled = false; startCaptureBtn.classList.remove('active'); startCaptureBtn.innerHTML = `<i class="fas fa-bug"></i> 日志抓取`; }, duration * 1000); })
                .catch(err => { showToast('启动采集失败', 'error'); startCaptureBtn.disabled = false; startCaptureBtn.classList.remove('active'); startCaptureBtn.innerHTML = `<i class="fas fa-bug"></i> 日志抓取`; });
            });

            getLogsBtn.addEventListener('click', () => {
                getLogsBtn.disabled = true; getLogsBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 正在获取...`;
                getById('log-analysis-container').style.display = 'grid';
                getById('log-request-list').innerHTML = '<div id="loading-spinner" style="display: block; margin: 4rem auto;"></div>';
                getById('log-flowchart-container').innerHTML = '<p style="color: var(--log-label-color); margin-top: 2rem;">正在获取和分析日志...</p>';
                fetch(`${mosdnsHost}/api/v1/capture/logs`).then(response => response.json())
                .then(logs => {
                    if (logs.length === 0) {
                       showToast('没有采集到任何Debug日志。', 'error');
                       getById('log-request-list').innerHTML = '<p style="text-align:center; padding: 1rem; color: var(--log-label-color);">没有采集到任何Debug日志。</p>';
                       getById('log-flowchart-container').innerHTML = '';
                    } else {
                       showToast(`成功获取 ${logs.length} 条日志，正在分析...`, 'success');
                       processAndRenderLogs(logs);
                    }
                })
                .catch(err => { showToast('获取日志失败', 'error'); getById('log-request-list').innerHTML = `<p class="error-message" style="margin:0;padding:1rem;">${err.message}</p>`; })
                .finally(() => { getLogsBtn.disabled = false; getLogsBtn.innerHTML = `<i class="fas fa-search"></i> 获取日志`; });
            });
        }
        
        // --- START OF REVISED LOG RENDERING LOGIC ---
        function sanitizeForMermaid(str) {
            if (typeof str !== 'string') return '';
            const replacements = { ':': '&#58;', '(': '&#40;', ')': '&#41;', '{': '&#123;', '}': '&#125;', '"': '&quot;', "'": '&#39;',  '@': '&#64;', '<': '&lt;', '>': '&gt;' };
            return str.replace(/[:(){}"'@<>]/g, char => replacements[char]);
        }

        function processAndRenderLogs(allLogs) {
            const requests = new Map();
            for (const log of allLogs) {
                if (!log.trace_id) continue;
                if (!requests.has(log.trace_id)) { requests.set(log.trace_id, { domain: log.domain || 'N/A', startTime: log.time, logs: [] }); }
                const reqData = requests.get(log.trace_id);
                if (log.domain && reqData.domain === 'N/A') { reqData.domain = log.domain; }
                reqData.logs.push(log);
            }

            const requestListDiv = getById('log-request-list');
            requestListDiv.innerHTML = '';
            
            const rawLogItem = createElement('div', 'log-request-item');
            rawLogItem.dataset.traceId = 'raw';
            rawLogItem.innerHTML = `<span class="domain"><i class="fas fa-file-alt"></i> <strong>原始日志 (表格视图)</strong></span><div class="details"><span>全部 ${allLogs.length} 条</span></div>`;
            rawLogItem.addEventListener('click', (e) => {
                document.querySelectorAll('.log-request-item').forEach(el => el.classList.remove('active'));
                e.currentTarget.classList.add('active');
                renderRawLogsAsTable(allLogs);
            });
            requestListDiv.appendChild(rawLogItem);


            requests.forEach((data, traceId) => {
                const item = createElement('div', 'log-request-item');
                item.dataset.traceId = traceId;
                const startTime = new Date(data.startTime).toLocaleTimeString('it-IT');
                item.innerHTML = `<span class="domain">${data.domain}</span><div class="details"><span>${startTime}</span><span>Trace: ${traceId}</span></div>`;
                item.addEventListener('click', (e) => {
                    document.querySelectorAll('.log-request-item').forEach(el => el.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    renderStructuredList(data.logs);
                });
                requestListDiv.appendChild(item);
            });
            if (rawLogItem) { rawLogItem.click(); }
        }

        function renderRawLogsAsTable(logs) {
            const container = getById('log-flowchart-container');
            logs.sort((a, b) => new Date(a.time) - new Date(b.time));

            let tableHTML = `<div class="timeline-title">所有日志条目 (按时间排序)</div><table class="data-table">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>Trace ID</th>
                        <th>类型</th>
                        <th>名称/信息</th>
                        <th>结果</th>
                        <th>域名</th>
                    </tr>
                </thead>
                <tbody>`;

            for (const log of logs) {
                const time = new Date(log.time);
                const timeString = `${time.toLocaleTimeString('it-IT')}.${String(time.getMilliseconds()).padStart(3, '0')}`;
                const type = log.matcher_name ? 'Matcher' : (log.plugin_name ? 'Plugin' : 'Log');
                const name = log.matcher_name || log.plugin_name || log.logger_name || log.msg;
                const result = log.match_result === undefined ? '—' : (log.match_result ? '<span style="color:var(--log-timeline-matcher-ok-text)"><strong>TRUE</strong></span>' : '<span style="color:var(--log-timeline-matcher-fail-text)"><strong>FALSE</strong></span>'); 
                const domain = log.domain || '';

                tableHTML += `
                    <tr>
                        <td>${timeString}</td>
                        <td>${log.trace_id || ''}</td>
                        <td>${type}</td>
                        <td>${name}</td>
                        <td>${result}</td>
                        <td>${domain}</td>
                    </tr>`;
            }

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        function renderStructuredList(logs) {
            const container = getById('log-flowchart-container');
            container.innerHTML = ''; 

            logs.sort((a, b) => new Date(a.time) - new Date(b.time));

            const domain = logs[0]?.domain || 'Unknown Domain';
            const startTime = new Date(logs[0].time);
            const endTime = new Date(logs[logs.length-1].time);
            const duration = (endTime - startTime).toFixed(0);

            const title = createElement('h3', 'timeline-title');
            title.innerHTML = `DNS 查询流程: <strong>${domain}</strong> (总耗时: ${duration} ms)`;
            container.appendChild(title);

            const list = createElement('div', 'structured-log-list');

            let lastLoggerName = '';
            logs.forEach(log => {
                if (log.logger_name && log.logger_name !== lastLoggerName && !log.msg?.includes("lazy cache")) {
                    const sectionHeader = createElement('div', 'log-section-header');
                    sectionHeader.textContent = `进入序列: ${log.logger_name}`;
                    list.appendChild(sectionHeader);
                    lastLoggerName = log.logger_name;
                }
                
                const logItem = createElement('div', 'log-item');
                const timeDiff = ((new Date(log.time) - startTime)).toFixed(0);
                
                let iconHtml = '';
                let contentHtml = '';
                let resultHtml = '';
                
                if (log.matcher_name) {
                    logItem.classList.add('type-matcher');
                    iconHtml = `<i class="fas fa-question-circle"></i>`;
                    contentHtml = `<span class="name">${log.matcher_name}</span>`;
                    if (log.match_result) {
                        resultHtml = `<span class="result ok">✅ TRUE</span>`;
                        logItem.classList.add('result-ok');
                    } else {
                        resultHtml = `<span class="result fail">❌ FALSE</span>`;
                        logItem.classList.add('result-fail');
                    }
                } else if (log.plugin_name) {
                    logItem.classList.add('type-plugin');
                    iconHtml = `<i class="fas fa-cog"></i>`;
                    contentHtml = `<span class="name">${log.plugin_name}</span>`;
                }
                
                if(contentHtml) { 
                    logItem.innerHTML = `
                        <div class="log-item-main">
                            <span class="icon">${iconHtml}</span>
                            <span class="content">${contentHtml}</span>
                        </div>
                        <div class="log-item-meta">
                            ${resultHtml}
                            <span class="time">+${timeDiff}ms</span>
                        </div>
                    `;
                    list.appendChild(logItem);
                }
            });

            container.appendChild(list);
        }

        // --- END OF REVISED LOG RENDERING LOGIC ---

        document.addEventListener('DOMContentLoaded', async () => {
            // No need to initialize Mermaid here anymore
            dataModalSearchInput = getById('data-modal-search'); 

            setupEventListeners();
            setupCardToggles();
            
            const savedTheme = localStorage.getItem('theme') || 'light';
            const blurEnabled = localStorage.getItem('blurEnabled') !== 'false';
            const blurStrength = localStorage.getItem('blurStrength') || 12;
            const blurToggle = getById('blur-toggle'); const blurSlider = getById('blur-slider');
            
            blurToggle.checked = blurEnabled; blurSlider.value = blurStrength; blurSlider.disabled = !blurEnabled;
            D.documentElement.style.setProperty('--glass-blur-strength', `${blurEnabled ? blurStrength : 0}px`);
            
            setTheme(savedTheme);

            const activeTabButton = D.querySelector('.tab-button.active');
            if (activeTabButton) {
                const tabName = activeTabButton.dataset.tab;
                if (tabName === 'config-mgmt') await initializeSwitchManagementTab();
                if (tabName === 'list-mgmt') await initializeListManagementTab();
            }

            await refreshData(true, true);
            
            const autoRefresh = localStorage.getItem('autoRefresh') === 'true';
            getById('auto-refresh-toggle').checked = autoRefresh;
            if (autoRefresh) getById('auto-refresh-toggle').dispatchEvent(new Event('change'));
            
            initializeTooltips();
        });
    </script>
</body>
</html>
