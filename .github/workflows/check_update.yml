name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°

on:
  schedule:
    - cron: '0 2,14 * * *'  # æ¯å¤© UTC 2:00 å’Œ 14:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00 å’Œ 22:00ï¼‰
  workflow_dispatch:         # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: è®¾ç½®ç¼“å­˜ç›®å½•
        run: mkdir -p $HOME/upstream-cache

      - name: æ¢å¤ä¸Šæ¸¸çŠ¶æ€ç¼“å­˜
        id: cache
        uses: actions/cache@v3
        with:
          path: $HOME/upstream-cache
          key: upstream-status-${{ github.repository }}

      - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
        id: check_updates
        run: |
          # 1. è·å–ä¸Šæ¸¸ä»“åº“æœ€æ–°æäº¤
          UPSTREAM_REPO="https://github.com/yyysuo/mosdns.git"
          
          # 2. ä¸´æ—¶å…‹éš†ä¸Šæ¸¸ä»“åº“ï¼ˆåªè·å–æœ€æ–°æäº¤ï¼‰
          git clone --depth=1 $UPSTREAM_REPO temp-upstream || exit 1
          cd temp-upstream
          
          # 3. è·å–å½“å‰æœ€æ–°æäº¤å“ˆå¸Œ
          CURRENT_HEAD=$(git rev-parse HEAD)
          echo "current_head=$CURRENT_HEAD" >> $GITHUB_ENV
          
          # 4. è¯»å–ä¸Šæ¬¡è®°å½•çš„æäº¤å“ˆå¸Œ
          LAST_HEAD_FILE="$HOME/upstream-cache/last_head"
          LAST_HEAD=""
          if [ -f "$LAST_HEAD_FILE" ]; then
            LAST_HEAD=$(cat "$LAST_HEAD_FILE")
            echo "last_head=$LAST_HEAD" >> $GITHUB_ENV
          fi
          
          # 5. æ¯”è¾ƒæ˜¯å¦æœ‰æ–°æäº¤
          if [ "$CURRENT_HEAD" != "$LAST_HEAD" ]; then
            echo "has_update=true" >> $GITHUB_ENV
            
            # 6. è·å–æœ€æ–°æäº¤ä¿¡æ¯
            LATEST_COMMIT=$(git log -1 --oneline)
            echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_ENV
            echo "update_count=1" >> $GITHUB_ENV
            
            # 7. æ›´æ–°ç¼“å­˜
            echo "$CURRENT_HEAD" > "$LAST_HEAD_FILE"
            echo "âœ… æ£€æµ‹åˆ°ä¸Šæ¸¸æœ‰æ–°æäº¤ï¼"
          else
            echo "has_update=false" >> $GITHUB_ENV
            echo "âœ… ä¸Šæ¸¸æ— æ–°æ›´æ–°ï¼ˆçŠ¶æ€æ­£å¸¸ï¼‰"
          fi
          
          # 8. è·å–æäº¤æ—¶é—´ï¼ˆç”¨äºé€šçŸ¥ï¼‰
          COMMIT_TIME=$(git log -1 --format="%cd" --date="format:%Y-%m-%d %H:%M:%S")
          echo "commit_time=$COMMIT_TIME" >> $GITHUB_ENV
          
          # 9. è®¾ç½®ä¸Šæ¸¸ä»“åº“é“¾æ¥
          echo "upstream_url=https://github.com/yyysuo/mosdns" >> $GITHUB_ENV
          
          # 10. è®¾ç½®æ£€æµ‹æ—¶é—´
          DETECT_TIME=$(date +"%Y-%m-%d %H:%M:%S UTC")
          echo "detect_time=$DETECT_TIME" >> $GITHUB_ENV
          
          # 11. æ¸…ç†
          cd ..
          rm -rf temp-upstream

      - name: å‘é€ Telegram é€šçŸ¥ï¼ˆä»…å½“æœ‰æ›´æ–°æ—¶ï¼‰
        if: env.has_update == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            ğŸš¨ *ã€ä¸Šæ¸¸ä»“åº“æ›´æ–°æé†’ã€‘*
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            
            ğŸ“¦ **ä¸Šæ¸¸ä»“åº“**ï¼š [yyysuo/mosdns](${{ env.upstream_url }})
            ğŸ’¡ **çŠ¶æ€**ï¼šå‘ç°æ–°æäº¤
            
            ğŸ“ **æœ€æ–°æäº¤**ï¼š
            ```
            ${{ env.latest_commit }}
            ```
            
            â° **æäº¤æ—¶é—´**ï¼š${{ env.commit_time }}
            ğŸ” **æ£€æµ‹æ—¶é—´**ï¼š${{ env.detect_time }}
            
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            â„¹ï¸ æœ¬é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€
            ğŸ“Œ æ— éœ€å›å¤ï¼Œæ­¤é€šçŸ¥ä»…åæ˜ ä¸Šæ¸¸ä»“åº“çŠ¶æ€
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
