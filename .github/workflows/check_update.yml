name: Check Upstream Update

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC æ—¶é—´ 2:00 AM è§¦å‘
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      UPSTREAM_REPO: "https://github.com/yyysuo/mosdns.git"  # ä¿®å¤1ï¼šæ ‡å‡† .git URL
      UPSTREAM_BRANCH: "main"  # æ˜ç¡®æŒ‡å®šä¸Šæ¸¸åˆ†æ”¯

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # å‡çº§åˆ°æœ€æ–°ç‰ˆ checkout action

      - name: Configure git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Add upstream and fetch
        run: |
          echo "ğŸ” Adding upstream remote: $UPSTREAM_REPO"
          git remote add upstream "$UPSTREAM_REPO" || echo "Remote already exists"
          
          echo "ğŸ“¥ Fetching upstream changes..."
          git fetch upstream --depth=1  # å‡å°‘æ•°æ®é‡ï¼ŒåŠ é€Ÿæ‰§è¡Œ
          
          echo "ğŸ“ Comparing commits:"
          git log HEAD..upstream/$UPSTREAM_BRANCH --oneline > diff.log || true
          
          echo "ğŸ“‹ Diff content:"
          cat diff.log || echo "No updates found"
        env:
          GIT_TERMINAL_PROMPT: 0  # ç¦ç”¨äº¤äº’å¼æç¤º

      - name: Check for updates
        id: update_check
        run: |
          if [ -s diff.log ]; then
            echo "âœ… Updates detected!"
            echo "has_update=true" >> $GITHUB_ENV
            echo "UPDATE_COUNT=$(wc -l < diff.log)" >> $GITHUB_ENV
          else
            echo "âŒ No updates found"
            echo "has_update=false" >> $GITHUB_ENV
          fi

      - name: Notify via Cloudflare Worker
        if: env.has_update == 'true'
        run: |
          # å®‰å…¨è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼ˆç‰¹åˆ«æ˜¯åŒå¼•å·ï¼‰
          ESCAPED_LOG=$(cat diff.log | head -n 5 | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
          
          PAYLOAD=$(cat <<EOF
          {
            "text": "ğŸ“¦ ä»“åº“ã€${{ github.repository }}ã€æ£€æµ‹åˆ° ${UPDATE_COUNT} æ¡æ›´æ–°ï¼\nğŸ“ æœ€æ–°æäº¤è®°å½•ï¼š\n$ESCAPED_LOG\nğŸ”— æŸ¥çœ‹æ›´æ–°: https://github.com/${{ github.repository }}/compare/$(git rev-parse HEAD)...$(git rev-parse upstream/$UPSTREAM_BRANCH)?expand=1"
          }
          EOF
          )
          
          echo "ğŸ“¤ Sending notification to Cloudflare Worker..."
          echo "Payload preview: ${PAYLOAD:0:200}..."  # ä»…æ˜¾ç¤ºå‰200å­—ç¬¦é¢„è§ˆ
          
          curl -X POST "${{ secrets.WORKER_URL }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            -w "\nHTTP Status: %{http_code}\n" \
            --fail  # é2xxçŠ¶æ€ç æ—¶å¤±è´¥
        env:
          UPDATE_COUNT: ${{ env.UPDATE_COUNT }}

      - name: Clean up
        run: |
          rm -f diff.log
          git remote remove upstream || true  # ç¡®ä¿æ¸…ç†è¿œç¨‹

      - name: Final status report
        run: |
          if [ "$has_update" = "true" ]; then
            echo "âœ… SUCCESS: Update notification sent!"
          else
            echo "âœ… SUCCESS: No updates found (expected behavior)"
          fi
