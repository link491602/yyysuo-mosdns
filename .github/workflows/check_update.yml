name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°

on:
  schedule:
    - cron: '0 2,14 * * *'
  workflow_dispatch:

# å…³é”®ï¼šæ·»åŠ å†™å…¥æƒé™ï¼Œå¦åˆ™æ— æ³• git push
permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # å»ºè®®è·å–å®Œæ•´å†å²ï¼Œé¿å…ä¸€äº› git æŠ¥é”™

      - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
        id: check_updates
        run: |
          # 1. å®šä¹‰çŠ¶æ€æ–‡ä»¶
          STATE_FILE=".github/last_upstream_commit"
          UPSTREAM_REPO="https://github.com/yyysuo/mosdns.git"
          
          # 2. ä¸´æ—¶å…‹éš†ä¸Šæ¸¸
          git clone --depth=1 $UPSTREAM_REPO temp-upstream || exit 1
          cd temp-upstream
          
          CURRENT_HEAD=$(git rev-parse HEAD)
          CURRENT_COMMIT=$(git log -1 --oneline)
          # è·å–ä½œè€…æ—¥æœŸï¼Œç¡®ä¿æ ¼å¼å…¼å®¹
          COMMIT_TIME=$(git log -1 --format="%cd" --date="format:%Y-%m-%d %H:%M:%S")
          cd ..
          
          # 3. è¯»å–æ—§çŠ¶æ€
          LAST_HEAD=""
          if [ -f "$STATE_FILE" ]; then
            LAST_HEAD=$(cat "$STATE_FILE")
          fi
          
          # 4. æ¯”è¾ƒ
          if [ "$CURRENT_HEAD" != "$LAST_HEAD" ]; then
            echo "has_update=true" >> $GITHUB_ENV
            
            # ä½¿ç”¨ EOF å†™å…¥ç¯å¢ƒå˜é‡ä»¥æ”¯æŒç‰¹æ®Šå­—ç¬¦ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
            {
              echo "latest_commit<<EOF"
              echo "$CURRENT_COMMIT"
              echo "EOF"
            } >> $GITHUB_ENV
            
            echo "commit_time=$COMMIT_TIME" >> $GITHUB_ENV
            echo "upstream_url=https://github.com/yyysuo/mosdns" >> $GITHUB_ENV
            echo "detect_time=$(date +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_ENV
            
            # 5. æ›´æ–°å¹¶æ¨é€
            mkdir -p .github
            echo "$CURRENT_HEAD" > "$STATE_FILE"
            
            git config user.name "github-actions"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add "$STATE_FILE"
            git commit -m "chore: update upstream state to $CURRENT_HEAD"
            git push origin main
          else
            echo "has_update=false" >> $GITHUB_ENV
            echo "âœ… æ— æ›´æ–°"
          fi
          
          rm -rf temp-upstream

      - name: å‘é€ Telegram é€šçŸ¥
        if: env.has_update == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          # æ³¨æ„ï¼šYAML ä¸­å¤šè¡Œå­—ç¬¦ä¸²ç¼©è¿›è¦æ­£ç¡®
          message: |
            ğŸš¨ *ã€ä¸Šæ¸¸ä»“åº“æ›´æ–°æé†’ã€‘*
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            
            ğŸ“¦ **ä»“åº“**ï¼š[yyysuo/mosdns](${{ env.upstream_url }})
            
            ğŸ“ **æœ€æ–°æäº¤**ï¼š
            `${{ env.latest_commit }}`
            
            â° **æäº¤æ—¶é—´**ï¼š${{ env.commit_time }}
            
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            â„¹ï¸ _By GitHub Actions_
