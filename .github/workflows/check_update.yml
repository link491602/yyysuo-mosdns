name: Check Upstream Update

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC æ—¶é—´ 2:00 AM æ£€æŸ¥
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for upstream updates
        id: check_updates
        run: |
          # 1. æ·»åŠ æ­£ç¡®çš„ä¸Šæ¸¸ä»“åº“
          git remote add upstream https://github.com/yyysuo/mosdns.git 2>/dev/null || echo "Remote already exists"
          
          # 2. è·å–ä¸Šæ¸¸æ›´æ–°
          git fetch upstream --depth=1
          
          # 3. æ¯”è¾ƒå·®å¼‚
          git log HEAD..upstream/main --oneline > diff.log || true
          
          # 4. æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if [ -s diff.log ]; then
            echo "has_update=true" >> $GITHUB_ENV
            echo "update_count=$(wc -l < diff.log)" >> $GITHUB_ENV
            echo "latest_commits<<EOF" >> $GITHUB_ENV
            cat diff.log | head -n 5 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "âœ… å‘ç° ${update_count} æ¡ä¸Šæ¸¸æ›´æ–°ï¼"
          else
            echo "has_update=false" >> $GITHUB_ENV
            echo "âœ… æ— æ–°æ›´æ–°ï¼ˆæ­£å¸¸çŠ¶æ€ï¼‰"
          fi
          
          # 5. ä¿å­˜ç”¨äºé‚®ä»¶çš„å®Œæ•´æ¯”è¾ƒé“¾æ¥
          BASE_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          echo "compare_url=https://github.com/yyysuo/mosdns/compare/${BASE_COMMIT}...${UPSTREAM_COMMIT}?expand=1" >> $GITHUB_ENV
          
          # 6. æ¸…ç†
          rm -f diff.log
          git remote remove upstream 2>/dev/null || true

      - name: Send email notification (only if updates found)
        if: env.has_update == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          # é‚®ç®±æœåŠ¡å™¨é…ç½® (ä½¿ç”¨ Secrets å­˜å‚¨æ•æ„Ÿä¿¡æ¯)
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          
          # é‚®ä»¶å†…å®¹
          subject: "ğŸ“¦ ${GITHUB_REPOSITORY} æ£€æµ‹åˆ° ${env.update_count} æ¡ä¸Šæ¸¸æ›´æ–°ï¼"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: GitHub Actions <${{ secrets.SMTP_USER }}>
          
          # HTML æ ¼å¼é‚®ä»¶ï¼ˆæ›´ç¾è§‚ï¼‰
          html_body: |
            <h2>ğŸ“¦ ä»“åº“æ›´æ–°é€šçŸ¥</h2>
            <p>æ£€æµ‹åˆ°ä»“åº“ <strong>${{ github.repository }}</strong> æœ‰ <strong>${{ env.update_count }} æ¡</strong> ä¸Šæ¸¸æ›´æ–°ï¼</p>
            
            <h3>ğŸ“ æœ€æ–°æäº¤è®°å½•</h3>
            <pre style="background:#f5f5f5;padding:10px;border-radius:5px">${{ env.latest_commits }}</pre>
            
            <h3>ğŸ”— æ“ä½œå»ºè®®</h3>
            <ul>
              <li>çœ‹æŸ¥çœ‹å·®å¼‚: <a href="${{ env.compare_url }}">GitHub æ¯”è¾ƒé¡µé¢</a></li>
              <li>æ‰‹åŠ¨åŒæ­¥: <code>git pull upstream main</code></li>
            </ul>
            
            <hr>
            <small>æ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ Â· <a href="https://github.com/${{ github.repository }}/actions">æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—</a></small>
