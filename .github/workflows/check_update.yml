name: Check Upstream Update

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC æ—¶é—´ 2:00 AM æ£€æŸ¥
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for upstream updates
        id: check_updates
        run: |
          # 1. æ·»åŠ æ­£ç¡®çš„ä¸Šæ¸¸ä»“åº“
          git remote add upstream https://github.com/yyysuo/mosdns.git 2>/dev/null || echo "Remote already exists"
          
          # 2. è·å–ä¸Šæ¸¸æ›´æ–°
          git fetch upstream --depth=1
          
          # 3. æ¯”è¾ƒå·®å¼‚
          git log HEAD..upstream/main --oneline > diff.log || true
          
          # 4. æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if [ -s diff.log ]; then
            echo "has_update=true" >> $GITHUB_ENV
            echo "update_count=$(wc -l < diff.log)" >> $GITHUB_ENV
            echo "latest_commits<<EOF" >> $GITHUB_ENV
            cat diff.log | head -n 5 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "âœ… å‘ç° ${update_count} æ¡ä¸Šæ¸¸æ›´æ–°ï¼"
          else
            echo "has_update=false" >> $GITHUB_ENV
            echo "âœ… æ— æ–°æ›´æ–°ï¼ˆæ­£å¸¸çŠ¶æ€ï¼‰"
          fi
          
          # 5. ä¿å­˜ç”¨äºé€šçŸ¥çš„å®Œæ•´æ¯”è¾ƒé“¾æ¥
          BASE_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          echo "compare_url=https://github.com/yyysuo/mosdns/compare/${BASE_COMMIT}...${UPSTREAM_COMMIT}?expand=1" >> $GITHUB_ENV
          
          # 6. æ¸…ç†
          rm -f diff.log
          git remote remove upstream 2>/dev/null || true

      - name: Send Telegram notification (only if updates found)
        if: env.has_update == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ“¦ *${{ github.repository }} æœ‰æ›´æ–°ï¼*
            âœ… æ£€æµ‹åˆ° _${{ env.update_count }}_ æ¡æ–°æäº¤
            
            ğŸ“ *æœ€æ–°æäº¤è®°å½•ï¼š*
            ```
            ${{ env.latest_commits }}
            ```
            
            ğŸ”— [æŸ¥çœ‹å®Œæ•´å·®å¼‚](${{ env.compare_url }})
            â±ï¸ è‡ªåŠ¨æ£€æµ‹æ—¶é—´: $(date +"%Y-%m-%d %H:%M:%S UTC")
            
            â„¹ï¸ é€šè¿‡ GitHub Actions è‡ªåŠ¨é€šçŸ¥
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
