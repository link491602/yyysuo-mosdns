name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC æ—¶é—´ 2:00 AM æ£€æŸ¥
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
        id: check_updates
        run: |
          # 1. æ·»åŠ ä¸Šæ¸¸ä»“åº“ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
          git remote add upstream https://github.com/yyysuo/mosdns.git 2>/dev/null || echo "ä¸Šæ¸¸ä»“åº“å·²å­˜åœ¨"
          
          # 2. è·å–æ›´æ–°ï¼ˆé™åˆ¶æ·±åº¦ï¼‰
          git fetch upstream --depth=1 || exit 0
          
          # 3. æ¯”è¾ƒå·®å¼‚
          git log HEAD..upstream/main --oneline > diff.log || true
          
          # 4. æ£€æŸ¥æ›´æ–°
          if [ -s diff.log ]; then
            echo "has_update=true" >> $GITHUB_ENV
            echo "update_count=$(wc -l < diff.log | tr -d ' ')" >> $GITHUB_ENV
            echo "latest_commits<<EOF" >> $GITHUB_ENV
            cat diff.log | head -n 5 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "âœ… æ£€æµ‹åˆ° ${update_count} æ¡ä¸Šæ¸¸æ›´æ–°ï¼"
          else
            echo "has_update=false" >> $GITHUB_ENV
            echo "âœ… æ— æ–°æ›´æ–°ï¼ˆçŠ¶æ€æ­£å¸¸ï¼‰"
          fi
          
          # 5. ç”Ÿæˆæ¯”è¾ƒé“¾æ¥
          BASE_COMMIT=$(git rev-parse --short HEAD)
          UPSTREAM_COMMIT=$(git rev-parse --short upstream/main)
          echo "compare_url=https://github.com/yyysuo/mosdns/compare/${BASE_COMMIT}...${UPSTREAM_COMMIT}?expand=1" >> $GITHUB_ENV
          
          # 6. æ¸…ç†
          rm -f diff.log
          git remote remove upstream 2>/dev/null || true

      - name: å‘é€ Telegram é€šçŸ¥ï¼ˆä»…å½“æœ‰æ›´æ–°æ—¶ï¼‰
        if: env.has_update == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            ğŸš¨ *ã€ä»“åº“æ›´æ–°æé†’ã€‘*
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            
            ğŸ“¦ **ä»“åº“**ï¼š `${{ github.repository }}`
            ğŸ’¡ **çŠ¶æ€**ï¼šå‘ç° `${{ env.update_count }}` æ¡æ–°æäº¤
            
            ğŸ“ **æœ€æ–°æäº¤**ï¼š
            ```
            ${{ env.latest_commits }}
            ```
            
            ğŸ”— [ğŸ” æŸ¥çœ‹å®Œæ•´å·®å¼‚](${{ env.compare_url }})
            â° **æ£€æµ‹æ—¶é—´**ï¼š`$(date +"%Y-%m-%d %H:%M:%S UTC")`
            
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            â„¹ï¸ æœ¬é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€
            ğŸ“Œ æ— éœ€å›å¤ï¼Œæœ‰é—®é¢˜è¯·æ£€æŸ¥ Actions æ—¥å¿—
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
