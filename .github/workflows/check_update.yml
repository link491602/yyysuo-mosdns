name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°

on:
  schedule:
    - cron: '0 2,14 * * *'  # æ¯å¤© UTC 2:00 å’Œ 14:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00 å’Œ 22:00ï¼‰
  workflow_dispatch:         # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # éœ€è¦å†™å…¥æƒé™

      - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
        id: check_updates
        run: |
          # 1. å®šä¹‰çŠ¶æ€æ–‡ä»¶
          STATE_FILE=".github/last_upstream_commit"
          UPSTREAM_REPO="https://github.com/yyysuo/mosdns.git"
          
          # 2. ä¸´æ—¶å…‹éš†ä¸Šæ¸¸ï¼ˆåªè·å–æœ€æ–°æäº¤ï¼‰
          git clone --depth=1 $UPSTREAM_REPO temp-upstream || exit 1
          cd temp-upstream
          
          # 3. è·å–å½“å‰æœ€æ–°æäº¤å“ˆå¸Œ
          CURRENT_HEAD=$(git rev-parse HEAD)
          CURRENT_COMMIT=$(git log -1 --oneline)
          COMMIT_TIME=$(git log -1 --format="%cd" --date="format:%Y-%m-%d %H:%M:%S")
          cd ..
          
          # 4. è¯»å–ä¸Šæ¬¡è®°å½•çš„æäº¤å“ˆå¸Œ
          LAST_HEAD=""
          if [ -f "$STATE_FILE" ]; then
            LAST_HEAD=$(cat "$STATE_FILE")
            echo "ä¸Šæ¬¡è®°å½•çš„æäº¤: $LAST_HEAD"
          else
            echo "é¦–æ¬¡è¿è¡Œï¼Œåˆ›å»ºçŠ¶æ€æ–‡ä»¶"
          fi
          
          # 5. æ¯”è¾ƒæ˜¯å¦æœ‰æ–°æäº¤
          if [ "$CURRENT_HEAD" != "$LAST_HEAD" ]; then
            echo "has_update=true" >> $GITHUB_ENV
            echo "latest_commit=$CURRENT_COMMIT" >> $GITHUB_ENV
            echo "commit_time=$COMMIT_TIME" >> $GITHUB_ENV
            
            # 6. æ›´æ–°çŠ¶æ€æ–‡ä»¶
            mkdir -p .github
            echo "$CURRENT_HEAD" > "$STATE_FILE"
            git config user.name "github-actions"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add "$STATE_FILE"
            git commit -m "æ›´æ–°ä¸Šæ¸¸çŠ¶æ€: $CURRENT_HEAD" || echo "æ— å˜æ›´éœ€è¦æäº¤"
            git push origin main || echo "æ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ— å˜æ›´"
            
            echo "âœ… æ£€æµ‹åˆ°ä¸Šæ¸¸æ–°æäº¤ï¼Œå·²æ›´æ–°çŠ¶æ€æ–‡ä»¶"
          else
            echo "has_update=false" >> $GITHUB_ENV
            echo "âœ… ä¸Šæ¸¸æ— æ–°æ›´æ–°ï¼ˆçŠ¶æ€æ­£å¸¸ï¼‰"
          fi
          
          # 7. è®¾ç½®å…¶ä»–ç¯å¢ƒå˜é‡
          echo "upstream_url=https://github.com/yyysuo/mosdns" >> $GITHUB_ENV
          echo "detect_time=$(date +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_ENV
          
          # 8. æ¸…ç†
          rm -rf temp-upstream

      - name: å‘é€ Telegram é€šçŸ¥ï¼ˆä»…å½“æœ‰æ›´æ–°æ—¶ï¼‰
        if: env.has_update == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            ğŸš¨ *ã€ä¸Šæ¸¸ä»“åº“æ›´æ–°æé†’ã€‘*
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            
            ğŸ“¦ **ä¸Šæ¸¸ä»“åº“**ï¼š [yyysuo/mosdns](${{ env.upstream_url }})
            ğŸ’¡ **çŠ¶æ€**ï¼šå‘ç°æ–°æäº¤
            
            ğŸ“ **æœ€æ–°æäº¤**ï¼š
            ```
            ${{ env.latest_commit }}
            ```
            
            â° **æäº¤æ—¶é—´**ï¼š${{ env.commit_time }}
            ğŸ” **æ£€æµ‹æ—¶é—´**ï¼š${{ env.detect_time }}
            
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            â„¹ï¸ æœ¬é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€
            ğŸ“Œ æ— éœ€å›å¤ï¼Œæ­¤é€šçŸ¥ä»…åæ˜ ä¸Šæ¸¸ä»“åº“çŠ¶æ€
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
